<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>–ê—ç—Ä–æ–¥—Ä—É–≥ ‚Äî —á–∞—Ç (–¥–µ–º–æ)</title>

  <style>
    :root{
      --bgTop:#0b4f87;
      --bgMid:#083a6d;
      --bgBot:#062a55;

      --text:#fff;
      --muted:rgba(255,255,255,.70);

      --bubble-bot: rgba(255,255,255,.14);
      --bubble-user:#f28a2a;

      --stroke: rgba(255,255,255,.14);

      --input-bg: rgba(255,255,255,.16);
      --input-stroke: rgba(255,255,255,.16);

      --btn-bg: rgba(255,255,255,.10);
      --btn-stroke: rgba(255,255,255,.18);

      --overlay: rgba(0,0,0,.38);
      --panel: rgba(7, 40, 80, .92);
      --panel-stroke: rgba(255,255,255,.14);

      --radius:18px;

      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);

      --header-h: 88px;
      --composer-h: 92px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      color:var(--text);
      background: radial-gradient(1200px 900px at 35% 25%, var(--bgTop) 0%, var(--bgMid) 45%, var(--bgBot) 100%);
      overflow:hidden;
    }

    .app{
      height:100%;
      display:flex;
      flex-direction:column;
    }

    /* ===== Header ===== */
    header{
      height: calc(var(--header-h) + var(--safe-top));
      padding: calc(14px + var(--safe-top)) 18px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(0,0,0,.14), rgba(0,0,0,0));
      backdrop-filter: blur(6px);
    }

    .icon-btn{
      width:46px;height:46px;
      border-radius:16px;
      border:1px solid var(--btn-stroke);
      background: var(--btn-bg);
      display:grid;
      place-items:center;
      box-shadow: 0 10px 22px rgba(0,0,0,.18);
      cursor:pointer;
      padding:0;
    }
    .icon-btn img{ width:22px;height:22px; object-fit:contain; display:block; }

    .brand{ display:flex; align-items:center; gap:10px; }
    .brand img{ height:22px; width:auto; display:block; }

    /* ===== Title ===== */
    .titlebar{ padding: 10px 20px 6px; }
    .titlebar h1{
      margin:0;
      font-size: 40px;
      font-weight: 800;
      letter-spacing:.2px;
      line-height:1.05;
    }

    /* ===== Chat area ===== */
    .chat{
      flex:1;
      display:flex;
      flex-direction:column;
      min-height:0;
      padding: 0 16px;
      position:relative;
    }

    .messages{
      flex:1;
      min-height:0;
      overflow:auto;
      padding: 8px 0 14px;
      -webkit-overflow-scrolling: touch;
      scroll-behavior:smooth;
    }
    .messages::-webkit-scrollbar{ width:8px; }
    .messages::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,.18);
      border-radius: 10px;
    }

    .empty-hint{
      margin: 18px 0 0;
      padding: 14px 14px;
      border: 1px dashed rgba(255,255,255,.18);
      border-radius: 16px;
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.75);
      line-height: 1.35;
    }

    .msg{
      margin: 18px 0;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .msg.bot{ align-items:flex-start; }
    .msg.user{ align-items:flex-end; }

    .label{
      font-size: 11px;
      letter-spacing: .6px;
      text-transform: uppercase;
      color: rgba(255,255,255,.55);
      padding: 0 6px;
    }

    .bubble{
      max-width: 78%;
      padding: 14px 16px;
      border-radius: var(--radius);
      border: 1px solid var(--stroke);
      box-shadow: 0 10px 22px rgba(0,0,0,.14);
      backdrop-filter: blur(6px);
      line-height: 1.35;
      font-size: 16px;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .bot .bubble{
      background: var(--bubble-bot);
      border-bottom-left-radius: 10px;
    }

    .user .bubble{
      background: var(--bubble-user);
      border-color: rgba(255,255,255,.08);
      border-bottom-right-radius: 10px;
    }

    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      padding: 0 6px;
      margin-top: 4px;
    }
    .chip{
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.10);
      color: rgba(255,255,255,.92);
      border-radius: 14px;
      padding: 10px 12px;
      font-size: 14px;
      cursor:pointer;
      box-shadow: 0 10px 20px rgba(0,0,0,.12);
      user-select:none;
    }
    .chip:active{ transform: translateY(1px); }

    /* ===== Composer ===== */
    .composer{
      height: calc(var(--composer-h) + var(--safe-bottom));
      padding: 12px 16px calc(12px + var(--safe-bottom));
      display:flex;
      align-items:center;
      gap:12px;
      position:relative;
      z-index:3;
    }

    .plus{
      width:54px;height:54px;
      border-radius: 16px;
      border: 1px solid var(--btn-stroke);
      background: rgba(255,255,255,.10);
      display:grid;
      place-items:center;
      box-shadow: 0 10px 22px rgba(0,0,0,.18);
      cursor:pointer;
      padding:0;
    }
    .plus img{ width:22px;height:22px; display:block; }

    .input{
      flex:1;
      height:54px;
      border-radius: 18px;
      border: 1px solid var(--input-stroke);
      background: var(--input-bg);
      color: var(--text);
      outline:none;
      padding: 0 16px;
      font-size: 17px;
      box-shadow: 0 10px 22px rgba(0,0,0,.16);
    }
    .input::placeholder{ color: rgba(255,255,255,.70); }

    .send{
      width:56px;height:54px;
      border-radius: 18px;
      border:none;
      background: var(--bubble-user);
      box-shadow: 0 12px 24px rgba(0,0,0,.22);
      display:grid;
      place-items:center;
      cursor:pointer;
      padding:0;
    }
    .send img{ width:22px;height:22px; display:block; }
    .send:disabled{
      filter: grayscale(.35) brightness(.9);
      cursor:not-allowed;
    }

    /* ===== Quick Actions Popup ===== */
    .overlay{
      position:absolute;
      inset:0;
      background: var(--overlay);
      backdrop-filter: blur(4px);
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease;
      z-index:10;
    }
    .overlay.open{
      opacity:1;
      pointer-events:auto;
    }

    .sheet{
      position:absolute;
      left: 16px;
      right: 16px;
      bottom: calc(var(--composer-h) + 10px + var(--safe-bottom));
      border-radius: 22px;
      border: 1px solid var(--panel-stroke);
      background: var(--panel);
      box-shadow: 0 24px 60px rgba(0,0,0,.28);
      padding: 14px;
      transform: translateY(10px);
      opacity:0;
      transition: transform .18s ease, opacity .18s ease;
    }
    .overlay.open .sheet{
      transform: translateY(0);
      opacity:1;
    }

    .sheet-title{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      padding: 4px 4px 10px;
    }
    .sheet-title h2{
      margin:0;
      font-size: 16px;
      font-weight: 800;
      letter-spacing:.2px;
    }
    .sheet-title p{
      margin:4px 0 0;
      color: rgba(255,255,255,.72);
      font-size: 13px;
      line-height: 1.3;
    }
    .sheet-close{
      width:40px;height:40px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.08);
      color: rgba(255,255,255,.9);
      cursor:pointer;
      font-size: 22px;
      line-height: 1;
      display:grid;
      place-items:center;
    }

    .actions{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      margin-top: 6px;
    }

    .action-card{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);
      border-radius: 18px;
      padding: 12px 12px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .action-card:active{ transform: translateY(1px); }

    .action-main{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
    }
    .action-name{
      font-weight: 800;
      font-size: 15px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .action-desc{
      font-size: 13px;
      color: rgba(255,255,255,.72);
      line-height: 1.25;
    }
    .action-go{
      flex:0 0 auto;
      width:36px;height:36px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);
      display:grid;
      place-items:center;
      color: rgba(255,255,255,.9);
      font-size: 18px;
    }

    .crew-btn{
      margin-top: 10px;
      width:100%;
      border:none;
      border-radius: 18px;
      background: var(--bubble-user);
      color:#fff;
      font-weight: 900;
      letter-spacing:.2px;
      padding: 14px 14px;
      cursor:pointer;
      box-shadow: 0 14px 28px rgba(0,0,0,.22);
    }
    .crew-btn:active{ transform: translateY(1px); }

    /* ===== Tablet landscape ===== */
    @media (min-width: 820px) and (orientation: landscape){
      .app{ align-items:center; }
      header,.titlebar,.chat,.composer{
        width: min(920px, 92vw);
      }
      .bubble{ max-width: 62%; }
      .titlebar h1{ font-size: 44px; }

      .sheet{
        left: 0;
        right: 0;
      }
    }

    @media (max-width: 360px){
      .titlebar h1{ font-size: 36px; }
      .bubble{ font-size: 15px; }
    }
  </style>
</head>

<body>
  <div class="app">

    <header>
      <!-- –ò–ö–û–ù–ö–ê –ë–£–†–ì–ï–†–ê (—É–∂–µ –ø—Ä–æ–ø–∏—Å–∞–Ω–æ –≤–∞—à–∏–º –ø—É—Ç—ë–º) -->
      <button class="icon-btn" type="button" aria-label="–ú–µ–Ω—é">
        <img src="Icon/Burger-menu.svg" alt="" />
      </button>

      <!-- –õ–û–ì–û–¢–ò–ü (—É–∂–µ –ø—Ä–æ–ø–∏—Å–∞–Ω–æ –≤–∞—à–∏–º –ø—É—Ç—ë–º) -->
      <div class="brand" aria-label="Aeroflot">
        <img src="Logo/CMYK.svg" alt="AEROFLOT" />
      </div>
    </header>

    <div class="titlebar">
      <h1>–ê—ç—Ä–æ–¥—Ä—É–≥</h1>
    </div>

    <main class="chat">
      <div id="messages" class="messages" role="log" aria-live="polite" aria-relevant="additions">
        <div id="emptyHint" class="empty-hint">
          –ù–∞–∂–º–∏—Ç–µ ¬´+¬ª –¥–ª—è —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –∏–ª–∏ –∑–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å ‚Äî —è –ø–æ–º–æ–≥—É –ø–æ —Ö–æ–¥—É –ø–æ–ª—ë—Ç–∞.
        </div>
      </div>

      <!-- Overlay + Sheet -->
      <div id="overlay" class="overlay" aria-hidden="true">
        <div class="sheet" role="dialog" aria-label="–ü–æ–¥—Å–∫–∞–∑–∫–∏">
          <div class="sheet-title">
            <div>
              <h2>–ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å –≤ –ø–æ–ª—ë—Ç–µ</h2>
              <p>–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ü–µ–Ω–∞—Ä–∏–π ‚Äî —è –∑–∞–¥–∞–º –ø–∞—Ä—É –≤–æ–ø—Ä–æ—Å–æ–≤ –∏ –ø—Ä–µ–¥–ª–æ–∂—É –≤–∞—Ä–∏–∞–Ω—Ç.</p>
            </div>
            <button id="closeSheet" class="sheet-close" type="button" aria-label="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
          </div>

          <div class="actions">
            <button class="action-card" type="button" data-action="watch">
              <div class="action-main">
                <div class="action-name">üé¨ –ü–æ–¥–±–æ—Ä–∫–∞ –Ω–∞ —ç—Ç–æ—Ç —Ä–µ–π—Å</div>
                <div class="action-desc">–§–∏–ª—å–º –∏–ª–∏ —Å–µ—Ä–∏–∞–ª –ø–æ–¥ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ–ª—ë—Ç–∞ –∏ –≤–∫—É—Å.</div>
              </div>
              <div class="action-go">‚Ä∫</div>
            </button>

            <button class="action-card" type="button" data-action="sleep">
              <div class="action-main">
                <div class="action-name">üåô –ú—è–≥–∫–æ —É—Å–Ω—É—Ç—å</div>
                <div class="action-desc">–î—ã—Ö–∞–Ω–∏–µ, —Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–∏–µ –∏ ‚Äú–≤—ã–∫–ª—é—á–µ–Ω–∏–µ –≥–æ–ª–æ–≤—ã‚Äù.</div>
              </div>
              <div class="action-go">‚Ä∫</div>
            </button>

            <button class="action-card" type="button" data-action="flyover">
              <div class="action-main">
                <div class="action-name">üó∫Ô∏è –ß—Ç–æ –º—ã –ø—Ä–æ–ª–µ—Ç–∞–µ–º</div>
                <div class="action-desc">–ü–æ–¥—Å–∫–∞–∂—É –æ—Ä–∏–µ–Ω—Ç–∏—Ä—ã –ø–æ –º–∞—Ä—à—Ä—É—Ç—É (–¥–µ–º–æ-—Ä–µ–∂–∏–º).</div>
              </div>
              <div class="action-go">‚Ä∫</div>
            </button>

            <button class="action-card" type="button" data-action="aircraft">
              <div class="action-main">
                <div class="action-name">‚úàÔ∏è –ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ–µ –æ —Å–∞–º–æ–ª—ë—Ç–µ</div>
                <div class="action-desc">–§–∞–∫—Ç—ã –ø—Ä–æ –ø–æ–ª—ë—Ç, –≤—ã—Å–æ—Ç—É, —Å–∫–æ—Ä–æ—Å—Ç—å –∏ —Å–∏—Å—Ç–µ–º—ã.</div>
              </div>
              <div class="action-go">‚Ä∫</div>
            </button>
          </div>

          <!-- –û–¢–î–ï–õ–¨–ù–ê–Ø –ö–ù–û–ü–ö–ê -->
          <button id="crewBtn" class="crew-btn" type="button">
            –°–≤—è–∑—å —Å –±–æ—Ä—Ç–ø—Ä–æ–≤–æ–¥–Ω–∏–∫–æ–º
          </button>
        </div>
      </div>

      <div class="composer">
        <!-- –ü–õ–Æ–° (—É–∂–µ –ø—Ä–æ–ø–∏—Å–∞–Ω–æ –≤–∞—à–∏–º –ø—É—Ç—ë–º) -->
        <button id="plus" class="plus" type="button" aria-label="–°—Ü–µ–Ω–∞—Ä–∏–∏">
          <img src="Icon/Plus.svg" alt="" />
        </button>

        <input id="input" class="input" type="text" placeholder="–°–ø—Ä–æ—Å–∏ –º–µ–Ω—è" autocomplete="off" />

        <!-- –û–¢–ü–†–ê–í–ö–ê (—É–∂–µ –ø—Ä–æ–ø–∏—Å–∞–Ω–æ –≤–∞—à–∏–º –ø—É—Ç—ë–º) -->
        <button id="send" class="send" type="button" aria-label="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">
          <img src="Icon/TextButton/arrow-up_20x20.svg" alt="" />
        </button>
      </div>
    </main>

  </div>

  <script>
    const messagesEl = document.getElementById('messages');
    const emptyHintEl = document.getElementById('emptyHint');
    const inputEl = document.getElementById('input');
    const sendEl = document.getElementById('send');

    const plusEl = document.getElementById('plus');
    const overlayEl = document.getElementById('overlay');
    const closeSheetEl = document.getElementById('closeSheet');
    const crewBtnEl = document.getElementById('crewBtn');

    // ====== –í–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–∏–∞–ª–æ–≥–æ–≤ ======
    // activeFlow: null | 'watch' | 'sleep' | 'flyover' | 'aircraft' | 'crew'
    let state = {
      activeFlow: null,
      step: null,
      data: {}
    };

    // –°—Ç–∏–ª—å "–ê—ç—Ä–æ–¥—Ä—É–≥–∞": –∫–æ—Ä–æ—Ç–∫–æ, —Å–ø–æ–∫–æ–π–Ω–æ, —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã, –±–µ–∑ –ª–∏—à–Ω–µ–≥–æ.
    function aeroSay(text, chips){
      addMessage({from:'bot', text, chips});
    }

    function userSay(text){
      addMessage({from:'user', text});
    }

    function hideEmptyHint(){
      if (emptyHintEl) emptyHintEl.style.display = 'none';
    }

    function addMessage({from, text, chips}){
      hideEmptyHint();

      const msg = document.createElement('div');
      msg.className = `msg ${from}`;

      const label = document.createElement('div');
      label.className = 'label';
      label.textContent = (from === 'bot') ? '–ê–≠–†–û–î–†–£–ì' : '–í—ã';

      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.textContent = text;

      msg.appendChild(label);
      msg.appendChild(bubble);

      if (Array.isArray(chips) && chips.length){
        const chipsWrap = document.createElement('div');
        chipsWrap.className = 'chips';
        for (const c of chips){
          const b = document.createElement('button');
          b.className = 'chip';
          b.type = 'button';
          b.textContent = c.label;
          b.addEventListener('click', () => {
            // –ß–∏–ø = –∫–∞–∫ –±—É–¥—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–∏–ª —Å–æ–æ–±—â–µ–Ω–∏–µ
            handleUserInput(c.value, true);
          });
          chipsWrap.appendChild(b);
        }
        msg.appendChild(chipsWrap);
      }

      messagesEl.appendChild(msg);
      requestAnimationFrame(() => {
        messagesEl.scrollTop = messagesEl.scrollHeight;
      });
    }

    function openSheet(){
      overlayEl.classList.add('open');
      overlayEl.setAttribute('aria-hidden','false');
    }
    function closeSheet(){
      overlayEl.classList.remove('open');
      overlayEl.setAttribute('aria-hidden','true');
    }

    plusEl.addEventListener('click', () => {
      if (overlayEl.classList.contains('open')) closeSheet();
      else openSheet();
    });

    closeSheetEl.addEventListener('click', closeSheet);
    overlayEl.addEventListener('click', (e) => {
      // –∑–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ –∫–ª–∏–∫—É –Ω–∞ –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ
      if (e.target === overlayEl) closeSheet();
    });

    // ====== –°—Ü–µ–Ω–∞—Ä–∏–∏ –∏–∑ –≤—Å–ø–ª—ã–≤–∞—à–∫–∏ ======
    overlayEl.querySelectorAll('[data-action]').forEach(btn => {
      btn.addEventListener('click', () => {
        const action = btn.getAttribute('data-action');
        closeSheet();
        startFlow(action);
      });
    });

    crewBtnEl.addEventListener('click', () => {
      closeSheet();
      startFlow('crew');
    });

    function startFlow(flow){
      state.activeFlow = flow;
      state.data = {};
      state.step = null;

      switch(flow){
        case 'watch':
          state.step = 'askDuration';
          aeroSay(
            '–ü–æ–¥–±–µ—Ä—É —á—Ç–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å. –°–∫–æ–ª—å–∫–æ –ø—Ä–∏–º–µ—Ä–Ω–æ –ª–µ—Ç–µ—Ç—å? –ú–æ–∂–Ω–æ –≤ –º–∏–Ω—É—Ç–∞—Ö/—á–∞—Å–∞—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä: ‚Äú2:30‚Äù –∏–ª–∏ ‚Äú150 –º–∏–Ω—É—Ç‚Äù).',
            [
              {label:'–î–æ 1 —á–∞—Å–∞', value:'~1—á'},
              {label:'1‚Äì2 —á–∞—Å–∞', value:'~1-2—á'},
              {label:'2‚Äì4 —á–∞—Å–∞', value:'~2-4—á'},
              {label:'–ë–æ–ª—å—à–µ 4 —á–∞—Å–æ–≤', value:'~4+—á'}
            ]
          );
          break;

        case 'sleep':
          state.step = 'sleepIntro';
          aeroSay(
            '–°–¥–µ–ª–∞–µ–º –∫–æ—Ä–æ—Ç–∫—É—é ‚Äú–ø–æ—Å–∞–¥–∫—É –º–æ–∑–≥–∞‚Äù. –°–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏ –µ—Å—Ç—å?',
            [
              {label:'5 –º–∏–Ω—É—Ç', value:'5'},
              {label:'10 –º–∏–Ω—É—Ç', value:'10'},
              {label:'–ü—Ä–æ—Å—Ç–æ —Å–æ–≤–µ—Ç—ã', value:'tips'}
            ]
          );
          break;

        case 'flyover':
          state.step = 'flyoverAskRoute';
          aeroSay(
            '–ú–æ–≥—É –ø–æ–¥—Å–∫–∞–∑–∞—Ç—å –æ—Ä–∏–µ–Ω—Ç–∏—Ä—ã, –Ω–æ —ç—Ç–æ –¥–µ–º–æ-—Ä–µ–∂–∏–º –±–µ–∑ GPS. –ù–∞–ø–∏—à–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç (–æ—Ç–∫—É–¥–∞ ‚Üí –∫—É–¥–∞) –∏ –ø—Ä–∏–º–µ—Ä–Ω–æ–µ –≤—Ä–µ–º—è —Å –≤—ã–ª–µ—Ç–∞.'
          );
          break;

        case 'aircraft':
          state.step = 'aircraftFact';
          aeroSay(
            '–û–∫–µ–π. –ù–∞—á–Ω—É —Å –∫–æ—Ä–æ—Ç–∫–æ–≥–æ —Ñ–∞–∫—Ç–∞: –Ω–∞ –∫—Ä–µ–π—Å–µ—Ä—Å–∫–æ–º —Ä–µ–∂–∏–º–µ —Å–∞–º–æ–ª—ë—Ç –æ–±—ã—á–Ω–æ –ª–µ—Ç–∏—Ç –Ω–∞ –≤—ã—Å–æ—Ç–µ –ø–æ—Ä—è–¥–∫–∞ 10‚Äì12 –∫–º ‚Äî —ç—Ç–æ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ –ø–æ —Ä–∞—Å—Ö–æ–¥—É —Ç–æ–ø–ª–∏–≤–∞ –∏ –ø–æ–≥–æ–¥–µ.',
            [
              {label:'–ï—â—ë —Ñ–∞–∫—Ç', value:'–µ—â—ë'},
              {label:'–ü—Ä–æ —Å–∫–æ—Ä–æ—Å—Ç—å', value:'—Å–∫–æ—Ä–æ—Å—Ç—å'},
              {label:'–ü—Ä–æ —Ç—É—Ä–±—É–ª–µ–Ω—Ç–Ω–æ—Å—Ç—å', value:'—Ç—É—Ä–±—É–ª–µ–Ω—Ç–Ω–æ—Å—Ç—å'}
            ]
          );
          break;

        case 'crew':
          state.step = 'crewConfirm';
          aeroSay(
            '–°–≤—è–∑—å —Å –±–æ—Ä—Ç–ø—Ä–æ–≤–æ–¥–Ω–∏–∫–æ–º ‚Äî –≤ –¥–µ–º–æ —ç—Ç–æ –∏–º–∏—Ç–∞—Ü–∏—è. –ï—Å–ª–∏ —ç—Ç–æ —Ä–µ–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å (–ø–æ–º–æ—â—å/–ø–ª–æ—Ö–æ–µ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ/–≤–æ–ø—Ä–æ—Å –ø–æ —Å–µ—Ä–≤–∏—Å—É), –ª—É—á—à–µ –Ω–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É –≤—ã–∑–æ–≤–∞ –Ω–∞–¥ –∫—Ä–µ—Å–ª–æ–º.\n\n–°–º–æ–¥–µ–ª–∏—Ä–æ–≤–∞—Ç—å ‚Äú–≤—ã–∑–æ–≤‚Äù –∑–¥–µ—Å—å?',
            [
              {label:'–î–∞, –≤—ã–∑–≤–∞—Ç—å', value:'–¥–∞'},
              {label:'–ù–µ—Ç', value:'–Ω–µ—Ç'}
            ]
          );
          break;
      }
    }

    // ====== –ü–∞—Ä—Å–µ—Ä –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –≤–≤–æ–¥–∞ ======
    function normalize(s){
      return (s || '').toLowerCase().replace(/—ë/g,'–µ').trim();
    }

    function parseDuration(text){
      // –ø—Ä–∏–Ω–∏–º–∞–µ—Ç ~1—á, ~1-2—á, ~2-4—á, ~4+—á, "2:30", "150 –º–∏–Ω—É—Ç", "2 —á–∞—Å–∞"
      const t = normalize(text);

      if (t.startsWith('~')){
        return t; // –≥—Ä—É–±–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è
      }
      // h:mm
      const hm = t.match(/^(\d{1,2})\s*:\s*(\d{1,2})$/);
      if (hm){
        const h = parseInt(hm[1],10);
        const m = parseInt(hm[2],10);
        if (!isNaN(h) && !isNaN(m)) return (h*60 + m) + '–º';
      }
      // minutes
      const min = t.match(/(\d{2,4})\s*(–º–∏–Ω|–º)\b/);
      if (min){
        const m = parseInt(min[1],10);
        if (!isNaN(m)) return m + '–º';
      }
      // hours
      const hr = t.match(/(\d{1,2})([.,]\d)?\s*(—á|—á–∞—Å)/);
      if (hr){
        const h = parseInt(hr[1],10);
        if (!isNaN(h)) return (h*60) + '–º';
      }
      return null;
    }

    function suggestWatchlist(durationTag, genre, format){
      // –¥–µ–º–æ-–ø–æ–¥–±–æ—Ä–∫–∏ (–±–µ–∑ –±—Ä–µ–Ω–¥–æ–≤/–∫–∞—Ç–∞–ª–æ–≥–æ–≤ –∞–≤–∏–∞–∫–æ–º–ø–∞–Ω–∏–∏), –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ
      // –≤—ã–±–∏—Ä–∞–µ–º ‚Äú–∫–æ—Ä–æ—Ç–∫–æ–µ/—Å—Ä–µ–¥–Ω–µ–µ/–¥–ª–∏–Ω–Ω–æ–µ‚Äù
      let bucket = 'mid';
      const t = durationTag || '';
      if (t.includes('~1—á') || t.includes('60') || t.includes('~1-2—á')) bucket = 'short';
      if (t.includes('~2-4—á') || (t.includes('–º') && parseInt(t) >= 150)) bucket = 'mid';
      if (t.includes('~4+—á') || (t.includes('–º') && parseInt(t) >= 240)) bucket = 'long';

      const packs = {
        short: {
          film: [
            '–õ—ë–≥–∫–∞—è –∫–æ–º–µ–¥–∏—è –Ω–∞ 80‚Äì100 –º–∏–Ω—É—Ç',
            '–î–µ—Ç–µ–∫—Ç–∏–≤–Ω—ã–π —Ç—Ä–∏–ª–ª–µ—Ä ‚Äú–Ω–∞ –æ–¥–∏–Ω –ø—Ä–∏—Å–µ—Å—Ç‚Äù',
            '–î–æ–∫—É–º–µ–Ω—Ç–∞–ª–∫–∞ –Ω–∞ 60‚Äì90 –º–∏–Ω—É—Ç'
          ],
          series: [
            '–ú–∏–Ω–∏-—Å–µ—Ä–∏–∞–ª: 2‚Äì3 –∫–æ—Ä–æ—Ç–∫–∏—Ö —ç–ø–∏–∑–æ–¥–∞',
            '–û–¥–∏–Ω —ç–ø–∏–∑–æ–¥ ‚Äú–ø–∏–ª–æ—Ç + —Å–ª–µ–¥—É—é—â–∏–π‚Äù',
            '–ê–Ω—Ç–æ–ª–æ–≥–∏—è: 1 —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–∞—è —Å–µ—Ä–∏—è'
          ]
        },
        mid: {
          film: [
            '–ü—Ä–∏–∫–ª—é—á–µ–Ω—á–µ—Å–∫–∏–π —Ñ–∏–ª—å–º ~110‚Äì130 –º–∏–Ω—É—Ç',
            '–î—Ä–∞–º–∞ —Å —Å–∏–ª—å–Ω—ã–º —Å—é–∂–µ—Ç–æ–º ~120 –º–∏–Ω—É—Ç',
            '–≠–∫—à–µ–Ω ~115 –º–∏–Ω—É—Ç –±–µ–∑ ‚Äú–ø—Ä–æ–≤–∏—Å–∞–Ω–∏–π‚Äù'
          ],
          series: [
            '–°–µ—Ä–∏–∞–ª: 3‚Äì5 —ç–ø–∏–∑–æ–¥–æ–≤ –ø–æ 30 –º–∏–Ω—É—Ç',
            '–°–µ—Ä–∏–∞–ª: 2‚Äì3 —ç–ø–∏–∑–æ–¥–∞ –ø–æ 45 –º–∏–Ω—É—Ç',
            '–ú–∏–Ω–∏-–¥–µ—Ç–µ–∫—Ç–∏–≤: 3 —ç–ø–∏–∑–æ–¥–∞'
          ]
        },
        long: {
          film: [
            '–ë–æ–ª—å—à–æ–µ –∫–∏–Ω–æ 140‚Äì180 –º–∏–Ω—É—Ç',
            '–î–≤–∞ —Ñ–∏–ª—å–º–∞ –ø–æ–¥—Ä—è–¥: –ª—ë–≥–∫–∏–π + —Å—é–∂–µ—Ç–Ω—ã–π',
            '–î–æ–∫ + —Ö—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π: ‚Äú—Ñ–∞–∫—Ç–∞–º–∏ –∑–∞–∫—Ä–µ–ø–∏—Ç—å‚Äù'
          ],
          series: [
            '–°–µ–∑–æ–Ω–Ω—ã–π –º–∞—Ä–∞—Ñ–æ–Ω: 6‚Äì8 —ç–ø–∏–∑–æ–¥–æ–≤ –ø–æ 30 –º–∏–Ω—É—Ç',
            '4‚Äì5 —ç–ø–∏–∑–æ–¥–æ–≤ –ø–æ 45 –º–∏–Ω—É—Ç',
            '–ú–∏–Ω–∏-—Å–µ—Ä–∏–∞–ª: 5‚Äì6 —Å–µ—Ä–∏–π'
          ]
        }
      };

      const key = (format === '—Å–µ—Ä–∏–∞–ª') ? 'series' : 'film';
      const base = packs[bucket][key];

      // –∂–∞–Ω—Ä–æ–≤–∞—è –ø–æ–¥—Å—Ç—Ä–æ–π–∫–∞ (–º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è)
      const g = normalize(genre || '');
      if (g.includes('–∫–æ–º–µ–¥')) base.unshift('–ö–æ–º–µ–¥–∏—è —Å –∫–æ—Ä–æ—Ç–∫–∏–º–∏ —Å—Ü–µ–Ω–∞–º–∏ ‚Äî —Ö–æ—Ä–æ—à–æ –∑–∞—Ö–æ–¥–∏—Ç –≤ –ø–æ–ª—ë—Ç–µ');
      if (g.includes('—Ñ–∞–Ω—Ç–∞—Å—Ç') || g.includes('sci')) base.unshift('–§–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞/—Ñ—ç–Ω—Ç–µ–∑–∏: ‚Äú–ø–æ–≥—Ä—É–∂–µ–Ω–∏–µ‚Äù –ª–µ–≥—á–µ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç –≤—Ä–µ–º—è');
      if (g.includes('—É–∂–∞—Å') || g.includes('—Ö–æ—Ä—Ä–æ—Ä')) base.unshift('–•–æ—Ä—Ä–æ—Ä: –ª—É—á—à–µ, –µ—Å–ª–∏ –Ω–µ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ —Å—Ä–∞–∑—É —Å–ø–∞—Ç—å üôÇ');
      if (g.includes('–¥–æ–∫')) base.unshift('–î–æ–∫—É–º–µ–Ω—Ç–∞–ª–∫–∞: –æ—Ç–ª–∏—á–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç, –µ—Å–ª–∏ —Ö–æ—á–µ—Ç—Å—è ‚Äú–ø–æ –¥–µ–ª—É‚Äù');

      return base.slice(0,5);
    }

    function handleUserInput(text, fromChip=false){
      const trimmed = (text || '').trim();
      if (!trimmed) return;

      // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–∫ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ "–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π" –≤—ã–∑–æ–≤?
      // —á–∏–ø—ã —Ç–æ–∂–µ —Å—á–∏—Ç–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Äî —Ç–∞–∫ UX –ø–æ–Ω—è—Ç–Ω–µ–µ
      userSay(trimmed);

      // –µ—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è –Ω–µ—Ç ‚Äî –æ—Ç–≤–µ—á–∞–µ–º –æ–±—â–∏–º —Ç–æ–Ω–æ–º
      if (!state.activeFlow){
        const t = normalize(trimmed);
        if (t.includes('—á—Ç–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å') || t.includes('–ø–æ—Å–æ–≤–µ—Ç—É–π —Ñ–∏–ª—å–º') || t.includes('—Å–µ—Ä–∏–∞–ª')){
          startFlow('watch');
          return;
        }
        if (t.includes('—É—Å–Ω—É—Ç—å') || t.includes('–Ω–µ –º–æ–≥—É —É—Å–Ω—É—Ç—å') || t.includes('—Å–æ–Ω')){
          startFlow('sleep');
          return;
        }
        if (t.includes('—á—Ç–æ –ø—Ä–æ–ª–µ—Ç–∞–µ–º') || t.includes('–≥–¥–µ –ª–µ—Ç–∏–º') || t.includes('–Ω–∞–¥ —á–µ–º')){
          startFlow('flyover');
          return;
        }
        if (t.includes('—Å–∞–º–æ–ª–µ—Ç') || t.includes('—Å–∞–º–æ–ª—ë—Ç') || t.includes('—Ç—É—Ä–±—É–ª–µ–Ω—Ç')){
          startFlow('aircraft');
          return;
        }
        if (t.includes('–±–æ—Ä—Ç–ø—Ä–æ–≤–æ–¥') || t.includes('–ø–æ–º–æ–≥–∏') && t.includes('–ø–ª–æ—Ö–æ')){
          startFlow('crew');
          return;
        }

        aeroSay(
          '–Ø —Ä—è–¥–æ–º –Ω–∞ –≤—Ä–µ–º—è –ø–æ–ª—ë—Ç–∞. –ú–æ–≥—É: –ø–æ–¥–æ–±—Ä–∞—Ç—å —Ñ–∏–ª—å–º/—Å–µ—Ä–∏–∞–ª, –ø–æ–º–æ—á—å —É—Å–Ω—É—Ç—å, —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å —á—Ç–æ –º—ã –ø—Ä–æ–ª–µ—Ç–∞–µ–º (–≤ –¥–µ–º–æ), –∏–ª–∏ –¥–∞—Ç—å —Ñ–∞–∫—Ç—ã –æ —Å–∞–º–æ–ª—ë—Ç–µ. –ù–∞–∂–º–∏—Ç–µ ‚Äú+‚Äù –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤.'
        );
        return;
      }

      // ====== FLOW: WATCH ======
      if (state.activeFlow === 'watch'){
        if (state.step === 'askDuration'){
          const dur = parseDuration(trimmed);
          state.data.duration = dur || trimmed;
          state.step = 'askGenre';

          aeroSay(
            '–•–æ—Ä–æ—à–æ. –ö–∞–∫–æ–π –∂–∞–Ω—Ä –Ω—Ä–∞–≤–∏—Ç—Å—è –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ?',
            [
              {label:'–ö–æ–º–µ–¥–∏—è', value:'–∫–æ–º–µ–¥–∏—è'},
              {label:'–î–µ—Ç–µ–∫—Ç–∏–≤', value:'–¥–µ—Ç–µ–∫—Ç–∏–≤'},
              {label:'–î—Ä–∞–º–∞', value:'–¥—Ä–∞–º–∞'},
              {label:'–§–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞', value:'—Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞'},
              {label:'–î–æ–∫—É–º–µ–Ω—Ç–∞–ª—å–Ω–æ–µ', value:'–¥–æ–∫—É–º–µ–Ω—Ç–∞–ª—å–Ω–æ–µ'}
            ]
          );
          return;
        }

        if (state.step === 'askGenre'){
          state.data.genre = trimmed;
          state.step = 'askFormat';

          aeroSay(
            '–§–æ—Ä–º–∞—Ç: —Å–µ—Ä–∏–∞–ª –∏–ª–∏ —Ñ–∏–ª—å–º?',
            [
              {label:'–°–µ—Ä–∏–∞–ª', value:'—Å–µ—Ä–∏–∞–ª'},
              {label:'–§–∏–ª—å–º', value:'—Ñ–∏–ª—å–º'}
            ]
          );
          return;
        }

        if (state.step === 'askFormat'){
          const fmt = normalize(trimmed).includes('—Å–µ—Ä–∏–∞–ª') ? '—Å–µ—Ä–∏–∞–ª' : '—Ñ–∏–ª—å–º';
          state.data.format = fmt;

          const list = suggestWatchlist(state.data.duration, state.data.genre, fmt);
          aeroSay(
            `–ü–æ–¥ –≤–∞—Å –Ω–∞ ${state.data.duration || '—ç—Ç–æ—Ç –ø–µ—Ä–µ–ª—ë—Ç'}: \n‚Ä¢ ${list.join('\n‚Ä¢ ')}\n\n–ï—Å–ª–∏ —Å–∫–∞–∂–µ—Ç–µ ‚Äú—Ö–æ—á—É –ø–æ–ª–µ–≥—á–µ/–ø–æ–∂—ë—Å—Ç—á–µ/–ø–æ—É–º–Ω–µ–µ‚Äù ‚Äî —É—Ç–æ—á–Ω—é –ø–æ–¥–±–æ—Ä–∫—É.`,
            [
              {label:'–ü–æ–ª–µ–≥—á–µ', value:'–ø–æ–ª–µ–≥—á–µ'},
              {label:'–ü–æ–∂—ë—Å—Ç—á–µ', value:'–ø–æ–∂—ë—Å—Ç—á–µ'},
              {label:'–ü–æ—É–º–Ω–µ–µ', value:'–ø–æ—É–º–Ω–µ–µ'},
              {label:'–°–º–µ–Ω–∏—Ç—å –∂–∞–Ω—Ä', value:'—Å–º–µ–Ω–∏—Ç—å –∂–∞–Ω—Ä'}
            ]
          );

          state.step = 'refine';
          return;
        }

        if (state.step === 'refine'){
          const t = normalize(trimmed);
          if (t.includes('—Å–º–µ–Ω–∏—Ç—å')){
            state.step = 'askGenre';
            aeroSay('–û–∫–µ–π. –ö–∞–∫–æ–π –∂–∞–Ω—Ä –±–µ—Ä—ë–º —Ç–µ–ø–µ—Ä—å?', [
              {label:'–ö–æ–º–µ–¥–∏—è', value:'–∫–æ–º–µ–¥–∏—è'},
              {label:'–î–µ—Ç–µ–∫—Ç–∏–≤', value:'–¥–µ—Ç–µ–∫—Ç–∏–≤'},
              {label:'–î—Ä–∞–º–∞', value:'–¥—Ä–∞–º–∞'},
              {label:'–§–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞', value:'—Ñ–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞'},
              {label:'–î–æ–∫—É–º–µ–Ω—Ç–∞–ª—å–Ω–æ–µ', value:'–¥–æ–∫—É–º–µ–Ω—Ç–∞–ª—å–Ω–æ–µ'}
            ]);
            return;
          }
          aeroSay('–ü—Ä–∏–Ω—è—Ç–æ. –ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ ‚Äî –Ω–∞–∑–æ–≤–∏—Ç–µ 2‚Äì3 –ª—é–±–∏–º—ã—Ö —Ñ–∏–ª—å–º–∞/—Å–µ—Ä–∏–∞–ª–∞, –∏ —è –ø–æ–¥—Å—Ç—Ä–æ—é —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ —Ç–æ—á–Ω–µ–µ.');
          // –æ—Å—Ç–∞–≤–ª—è–µ–º flow –∞–∫—Ç–∏–≤–Ω—ã–º, –Ω–æ –±–µ–∑ –∂—ë—Å—Ç–∫–æ–≥–æ —à–∞–≥–∞
          state.step = 'open';
          return;
        }

        aeroSay('–û–∫–µ–π. –°—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π—Ç–µ: ‚Äú—Ñ–∏–ª—å–º/—Å–µ—Ä–∏–∞–ª + –∂–∞–Ω—Ä + —Å–∫–æ–ª—å–∫–æ –ª–µ—Ç–µ—Ç—å‚Äù ‚Äî –∏ —è –±—ã—Å—Ç—Ä–æ –ø–æ–¥–±–µ—Ä—É.');
        return;
      }

      // ====== FLOW: SLEEP ======
      if (state.activeFlow === 'sleep'){
        const t = normalize(trimmed);

        if (state.step === 'sleepIntro'){
          if (t === '5' || t.includes('5')){
            state.step = 'sleep5';
            aeroSay(
              '5 –º–∏–Ω—É—Ç. –ü–æ–µ—Ö–∞–ª–∏:\n1) –£–¥–æ–±–Ω–æ —Å—è–¥—å—Ç–µ, –ø–æ–¥–±–æ—Ä–æ–¥–æ–∫ —á—É—Ç—å –≤–Ω–∏–∑.\n2) –í–¥–æ—Ö 4 —Å–µ–∫—É–Ω–¥—ã ‚Äî –≤—ã–¥–æ—Ö 6 —Å–µ–∫—É–Ω–¥. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ 8 —Ü–∏–∫–ª–æ–≤.\n3) –ù–∞ –∫–∞–∂–¥–æ–º –≤—ã–¥–æ—Ö–µ ‚Äú–æ—Ç–ø—É—Å–∫–∞–π—Ç–µ‚Äù –ø–ª–µ—á–∏ –∏ —á–µ–ª—é—Å—Ç—å.\n\n–°–∫–∞–∑–∞—Ç—å –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ (–µ—â—ë 2 –º–∏–Ω—É—Ç—ã) –∏–ª–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ?',
              [
                {label:'–ï—â—ë 2 –º–∏–Ω—É—Ç—ã', value:'–µ—â–µ'},
                {label:'–î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ', value:'–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ'}
              ]
            );
            return;
          }
          if (t === '10' || t.includes('10')){
            state.step = 'sleep10';
            aeroSay(
              '10 –º–∏–Ω—É—Ç. –ü–ª–∞–Ω:\n‚Ä¢ 2 –º–∏–Ω—É—Ç—ã –¥—ã—Ö–∞–Ω–∏–µ 4‚Äì6\n‚Ä¢ 3 –º–∏–Ω—É—Ç—ã —Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–∏–µ —Ç–µ–ª–∞ ‚Äú—Å–≤–µ—Ä—Ö—É –≤–Ω–∏–∑‚Äù\n‚Ä¢ 5 –º–∏–Ω—É—Ç –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è ‚Äú—Ç–∏—Ö–∏–π –∫–æ—Ä–∏–¥–æ—Ä‚Äù\n\n–•–æ—Ç–∏—Ç–µ ‚Äú—Ç–∏—Ö–æ –∏ –±–µ–∑ —Ç–µ–∫—Å—Ç–∞‚Äù (—Ç–æ–ª—å–∫–æ —Ç–∞–π–º–∏–Ω–≥) –∏–ª–∏ —Å –ø–æ–¥—Å–∫–∞–∑–∫–∞–º–∏?',
              [
                {label:'–¢–æ–ª—å–∫–æ —Ç–∞–π–º–∏–Ω–≥', value:'—Ç–∞–π–º–∏–Ω–≥'},
                {label:'–° –ø–æ–¥—Å–∫–∞–∑–∫–∞–º–∏', value:'–ø–æ–¥—Å–∫–∞–∑–∫–∏'}
              ]
            );
            return;
          }
          if (t.includes('—Å–æ–≤–µ—Ç') || t.includes('tips')){
            state.step = 'sleepTips';
            aeroSay(
              '–ë—ã—Å—Ç—Ä—ã–µ —Å–æ–≤–µ—Ç—ã –¥–ª—è —Å–Ω–∞ –≤ –∫—Ä–µ—Å–ª–µ:\n‚Ä¢ –ú–∞—Å–∫–∞/–∫–∞–ø—é—à–æ–Ω + –±–µ—Ä—É—à–∏\n‚Ä¢ –ü–ª–µ–¥ –ø–æ–¥ –ø–æ—è—Å–Ω–∏—Ü—É\n‚Ä¢ –ù–æ–≥–∏ —á—É—Ç—å –ø—Ä–∏–ø–æ–¥–Ω—è—Ç—å (—Å—É–º–∫–∞ –ø–æ–¥ —Å—Ç—É–ø–Ω–∏)\n‚Ä¢ –ù–µ –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª—è—Ç—å –∫–æ—Ñ–µ –∑–∞ 3‚Äì4 —á–∞—Å–∞\n\n–ï—Å–ª–∏ —Å–∫–∞–∂–µ—Ç–µ, –≥–¥–µ —Å–∏–¥–∏—Ç–µ (—É –æ–∫–Ω–∞/–ø—Ä–æ—Ö–æ–¥) ‚Äî –¥–∞–º –ø–∞—Ä—É –ª–∞–π—Ñ—Ö–∞–∫–æ–≤ –ø–æ–¥ –º–µ—Å—Ç–æ.'
            );
            return;
          }

          aeroSay('–í—ã–±–µ—Ä–∏—Ç–µ 5 –º–∏–Ω—É—Ç, 10 –º–∏–Ω—É—Ç –∏–ª–∏ ‚Äú–ø—Ä–æ—Å—Ç–æ —Å–æ–≤–µ—Ç—ã‚Äù.', [
            {label:'5 –º–∏–Ω—É—Ç', value:'5'},
            {label:'10 –º–∏–Ω—É—Ç', value:'10'},
            {label:'–ü—Ä–æ—Å—Ç–æ —Å–æ–≤–µ—Ç—ã', value:'tips'}
          ]);
          return;
        }

        if (state.step === 'sleep5'){
          if (t.includes('–µ—â–µ') || t.includes('–µ—â—ë')){
            aeroSay(
              '–ï—â—ë 2 –º–∏–Ω—É—Ç—ã:\n‚Ä¢ –ù–∞ –≤–¥–æ—Ö–µ –º—ã—Å–ª–µ–Ω–Ω–æ ‚Äú—Å—á–∏—Ç–∞–π—Ç–µ‚Äù –¥–æ 4\n‚Ä¢ –ù–∞ –≤—ã–¥–æ—Ö–µ ‚Äî –¥–æ 8\n–ï—Å–ª–∏ —Å–±–∏–ª–∏—Å—å ‚Äî —Å–ø–æ–∫–æ–π–Ω–æ –Ω–∞—á–Ω–∏—Ç–µ –∑–∞–Ω–æ–≤–æ.\n\n–ì–æ—Ç–æ–≤–æ. –ú–æ–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ –¥–µ—Ä–∂–∞—Ç—å –≤—ã–¥–æ—Ö –¥–ª–∏–Ω–Ω–µ–µ –≤–¥–æ—Ö–∞ ‚Äî –æ—Ä–≥–∞–Ω–∏–∑–º —Å–∞–º –Ω–∞—á–Ω—ë—Ç ‚Äú–≥–∞—Å–∏—Ç—å‚Äù –≤–æ–∑–±—É–∂–¥–µ–Ω–∏–µ.'
            );
            state.step = 'done';
            return;
          }
          if (t.includes('–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ')){
            aeroSay('–û–∫–µ–π. –ï—Å–ª–∏ –º—ã—Å–ª–∏ —Å–∫–∞—á—É—Ç ‚Äî –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –º—è–≥–∫–æ —Å—á–∏—Ç–∞—Ç—å –≤—ã–¥–æ—Ö–∏ –æ—Ç 1 –¥–æ 20 –∏ —Å–Ω–æ–≤–∞ —Å 1.');
            state.step = 'done';
            return;
          }
          aeroSay('–ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ, –Ω–∞–ø–∏—à–∏—Ç–µ ‚Äú–µ—â—ë‚Äù –∏–ª–∏ ‚Äú–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ‚Äù.');
          return;
        }

        if (state.step === 'sleep10'){
          if (t.includes('—Ç–∞–π–º–∏–Ω–≥')){
            aeroSay('–¢–∞–π–º–∏–Ω–≥: 2:00 –¥—ã—Ö–∞–Ω–∏–µ 4‚Äì6 ‚Üí 3:00 —Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–∏–µ ‚Üí 5:00 –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è. –°–∫–∞–∂–∏—Ç–µ ‚Äú—Å—Ç–∞—Ä—Ç‚Äù, –∏ —è –±—É–¥—É –æ—Ç–º–µ—á–∞—Ç—å —ç—Ç–∞–ø—ã —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏.');
            state.step = 'sleep10Start';
            return;
          }
          if (t.includes('–ø–æ–¥—Å–∫–∞–∑')){
            aeroSay('–û–∫–µ–π. –°–∫–∞–∂–∏—Ç–µ ‚Äú—Å—Ç–∞—Ä—Ç‚Äù. –Ø –±—É–¥—É –≤–µ—Å—Ç–∏ –∫–æ—Ä–æ—Ç–∫–∏–º–∏ –ø–æ–¥—Å–∫–∞–∑–∫–∞–º–∏, –±–µ–∑ –ª–∏—à–Ω–µ–≥–æ —Ç–µ–∫—Å—Ç–∞.');
            state.step = 'sleep10Start';
            return;
          }
          aeroSay('–í—ã–±–µ—Ä–∏—Ç–µ: ‚Äú—Ç–æ–ª—å–∫–æ —Ç–∞–π–º–∏–Ω–≥‚Äù –∏–ª–∏ ‚Äú—Å –ø–æ–¥—Å–∫–∞–∑–∫–∞–º–∏‚Äù.', [
            {label:'–¢–æ–ª—å–∫–æ —Ç–∞–π–º–∏–Ω–≥', value:'—Ç–∞–π–º–∏–Ω–≥'},
            {label:'–° –ø–æ–¥—Å–∫–∞–∑–∫–∞–º–∏', value:'–ø–æ–¥—Å–∫–∞–∑–∫–∏'}
          ]);
          return;
        }

        if (state.step === 'sleep10Start'){
          if (t.includes('—Å—Ç–∞—Ä—Ç')){
            // —É–ø—Ä–æ—â—ë–Ω–Ω–æ: –±–µ–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ —Ç–∞–π–º–µ—Ä–∞ (–Ω–æ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å)
            aeroSay('–°—Ç–∞—Ä—Ç. 2 –º–∏–Ω—É—Ç—ã: –≤–¥–æ—Ö 4 ‚Äî –≤—ã–¥–æ—Ö 6. –Ø –Ω–∞–ø–∏—à—É ‚Äú–¥–∞–ª—å—à–µ‚Äù, –∫–æ–≥–¥–∞ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å—Å—è.');
            setTimeout(() => aeroSay('–î–∞–ª—å—à–µ. 3 –º–∏–Ω—É—Ç—ã: —Ä–∞—Å—Å–ª–∞–±—å—Ç–µ –ª–æ–± ‚Üí –≥–ª–∞–∑–∞ ‚Üí —á–µ–ª—é—Å—Ç—å ‚Üí –ø–ª–µ—á–∏ ‚Üí —Ä—É–∫–∏.'), 2200);
            setTimeout(() => aeroSay('–§–∏–Ω–∞–ª. 5 –º–∏–Ω—É—Ç: –ø—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ ‚Äú—Ç–∏—Ö–∏–π –∫–æ—Ä–∏–¥–æ—Ä‚Äù, –∫–∞–∂–¥—ã–π —à–∞–≥ ‚Äî –≤—ã–¥–æ—Ö.'), 4400);
            setTimeout(() => aeroSay('–ì–æ—Ç–æ–≤–æ. –ï—Å–ª–∏ —Ö–æ—á–µ—Ç—Å—è ‚Äî –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ—Å–ª–µ–¥–Ω–∏–π —ç—Ç–∞–ø –µ—â—ë 3‚Äì5 –º–∏–Ω—É—Ç.'), 6600);
            state.step = 'done';
            return;
          }
          aeroSay('–ù–∞–ø–∏—à–∏—Ç–µ ‚Äú—Å—Ç–∞—Ä—Ç‚Äù, –∫–æ–≥–¥–∞ –±—É–¥–µ—Ç–µ –≥–æ—Ç–æ–≤—ã.');
          return;
        }

        aeroSay('–ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ ‚Äî –Ω–∞–∂–º–∏—Ç–µ ‚Äú+‚Äù –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–π —Å—Ü–µ–Ω–∞—Ä–∏–π, –ª–∏–±–æ –Ω–∞–ø–∏—à–∏—Ç–µ, —á—Ç–æ –º–µ—à–∞–µ—Ç —É—Å–Ω—É—Ç—å (—à—É–º/–º—ã—Å–ª–∏/–ø–æ–∑–∞).');
        return;
      }

      // ====== FLOW: FLYOVER ======
      if (state.activeFlow === 'flyover'){
        if (state.step === 'flyoverAskRoute'){
          state.data.route = trimmed;
          state.step = 'flyoverAskTime';
          aeroSay('–ü–æ–Ω—è–ª. –ê —Å–∫–æ–ª—å–∫–æ –ø—Ä–∏–º–µ—Ä–Ω–æ –ø—Ä–æ—à–ª–æ —Å –≤–∑–ª—ë—Ç–∞? (–Ω–∞–ø—Ä–∏–º–µ—Ä: ‚Äú20 –º–∏–Ω—É—Ç‚Äù, ‚Äú1:10‚Äù)');
          return;
        }

        if (state.step === 'flyoverAskTime'){
          state.data.timeFromTakeoff = trimmed;
          state.step = 'flyoverResult';

          aeroSay(
            `–î–µ–º–æ-–æ—Ç–≤–µ—Ç (–±–µ–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö): –ø–æ –º–∞—Ä—à—Ä—É—Ç—É ‚Äú${state.data.route}‚Äù —á–µ—Ä–µ–∑ ${state.data.timeFromTakeoff} —á–∞—Å—Ç–æ –ø—Ä–æ–ª–µ—Ç–∞—é—Ç –∫—Ä—É–ø–Ω—ã–µ –Ω–∞—Å–µ–ª—ë–Ω–Ω—ã–µ –ø—É–Ω–∫—Ç—ã –∏ –≤–æ–¥–æ—ë–º—ã –Ω–∞ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–∏ —Ç—Ä–∞—Å—Å—ã.\n\n–ï—Å–ª–∏ —Å–∫–∞–∂–µ—Ç–µ: ‚Äú–º—ã –ª–µ—Ç–∏–º —Å–µ–≤–µ—Ä–Ω–µ–µ/—é–∂–Ω–µ–µ‚Äù –∏–ª–∏ —É–≤–∏–¥–µ–ª–∏ —á—Ç–æ-—Ç–æ –≤ –∏–ª–ª—é–º–∏–Ω–∞—Ç–æ—Ä ‚Äî –ø–æ–ø—Ä–æ–±—É—é —Å—É–∑–∏—Ç—å –¥–æ 2‚Äì3 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤.`,
            [
              {label:'–Ø —É –æ–∫–Ω–∞', value:'—è —É –æ–∫–Ω–∞'},
              {label:'–í–∏–∂—É –æ–≥–Ω–∏ –≥–æ—Ä–æ–¥–∞', value:'–≤–∏–∂—É –æ–≥–Ω–∏'},
              {label:'–í–∏–∂—É –≤–æ–¥—É', value:'–≤–∏–∂—É –≤–æ–¥—É'},
              {label:'–°–º–µ–Ω–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç', value:'—Å–º–µ–Ω–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç'}
            ]
          );
          return;
        }

        if (state.step === 'flyoverResult'){
          const t = normalize(trimmed);
          if (t.includes('—Å–º–µ–Ω–∏—Ç—å')){
            state.step = 'flyoverAskRoute';
            aeroSay('–û–∫–µ–π. –ù–∞–ø–∏—à–∏—Ç–µ –Ω–æ–≤—ã–π –º–∞—Ä—à—Ä—É—Ç (–æ—Ç–∫—É–¥–∞ ‚Üí –∫—É–¥–∞).');
            return;
          }
          aeroSay('–ü—Ä–∏–Ω—è—Ç–æ. –î–ª—è —Ç–æ—á–Ω–æ–≥–æ ‚Äú—á—Ç–æ –ø—Ä–æ–ª–µ—Ç–∞–µ–º‚Äù –≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω—É–∂–µ–Ω –¥–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º –ø–æ–ª—ë—Ç–∞/–∫–∞—Ä—Ç–µ. –í –¥–µ–º–æ –º–æ–≥—É —Ç–æ–ª—å–∫–æ –≤–µ—Å—Ç–∏ –¥–∏–∞–ª–æ–≥ –∏ —É—Ç–æ—á–Ω–µ–Ω–∏—è.');
          return;
        }

        aeroSay('–ù–∞–ø–∏—à–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç (–æ—Ç–∫—É–¥–∞ ‚Üí –∫—É–¥–∞).');
        state.step = 'flyoverAskRoute';
        return;
      }

      // ====== FLOW: AIRCRAFT ======
      if (state.activeFlow === 'aircraft'){
        const t = normalize(trimmed);

        if (t.includes('–µ—â—ë')){
          const facts = [
            '–¢—É—Ä–±—É–ª–µ–Ω—Ç–Ω–æ—Å—Ç—å —á–∞—â–µ –Ω–µ–ø—Ä–∏—è—Ç–Ω–∞, —á–µ–º –æ–ø–∞—Å–Ω–∞: —Å–∞–º–æ–ª—ë—Ç —Ä–∞—Å—Å—á–∏—Ç–∞–Ω –Ω–∞ –±–æ–ª—å—à–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏, –∞ —ç–∫–∏–ø–∞–∂ –≤—ã–±–∏—Ä–∞–µ—Ç —Ä–µ–∂–∏–º –∏ –≤—ã—Å–æ—Ç—É.',
            '–ö—Ä–µ–π—Å–µ—Ä—Å–∫–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å —É –ª–∞–π–Ω–µ—Ä–æ–≤ –æ–±—ã—á–Ω–æ –≤ —Ä–∞–π–æ–Ω–µ ~800‚Äì900 –∫–º/—á (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–∏–ø–∞ –∏ —É—Å–ª–æ–≤–∏–π).',
            '–í —Å–∞–ª–æ–Ω –ø–æ–¥–∞—ë—Ç—Å—è ‚Äú—É—Å–ª–æ–≤–Ω–∞—è –≤—ã—Å–æ—Ç–∞‚Äù –Ω–∏–∂–µ —Ä–µ–∞–ª—å–Ω–æ–π: –¥–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç —Ç–∞–∫, —á—Ç–æ–±—ã –±—ã–ª–æ –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ –¥—ã—à–∞—Ç—å.',
            '–ù–∞ —ç—à–µ–ª–æ–Ω–µ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –∑–∞ –±–æ—Ä—Ç–æ–º –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–∫–æ–ª–æ ‚àí50¬∞C ‚Äî –ø–æ—ç—Ç–æ–º—É –≤–∞–∂–Ω—ã –æ–±–æ–≥—Ä–µ–≤ –∏ –∞–Ω—Ç–∏–æ–±–ª–µ–¥–µ–Ω–µ–Ω–∏–µ.'
          ];
          aeroSay(facts[Math.floor(Math.random()*facts.length)], [
            {label:'–ï—â—ë —Ñ–∞–∫—Ç', value:'–µ—â—ë'},
            {label:'–ü—Ä–æ —Ç—É—Ä–±—É–ª–µ–Ω—Ç–Ω–æ—Å—Ç—å', value:'—Ç—É—Ä–±—É–ª–µ–Ω—Ç–Ω–æ—Å—Ç—å'},
            {label:'–ü—Ä–æ –≤—ã—Å–æ—Ç—É', value:'–≤—ã—Å–æ—Ç–∞'},
            {label:'–ó–∞–∫–æ–Ω—á–∏—Ç—å', value:'–∑–∞–∫–æ–Ω—á–∏—Ç—å'}
          ]);
          state.step = 'aircraftFact';
          return;
        }

        if (t.includes('—Å–∫–æ—Ä–æ—Å—Ç—å')){
          aeroSay('–ü—Ä–æ —Å–∫–æ—Ä–æ—Å—Ç—å: –Ω–∞ –∫—Ä–µ–π—Å–µ –ª–∞–π–Ω–µ—Ä –¥–µ—Ä–∂–∏—Ç —Ä–µ–∂–∏–º, –≥–¥–µ —Ä–∞—Å—Ö–æ–¥ —Ç–æ–ø–ª–∏–≤–∞/–≤—Ä–µ–º—è –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã. –ù–∞ —Å–∫–æ—Ä–æ—Å—Ç—å –≤–ª–∏—è—é—Ç –≤–µ—Ç–µ—Ä (–≤—Å—Ç—Ä–µ—á–Ω—ã–π/–ø–æ–ø—É—Ç–Ω—ã–π) –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–∏—Å–ø–µ—Ç—á–µ—Ä–æ–≤.', [
            {label:'–ï—â—ë —Ñ–∞–∫—Ç', value:'–µ—â—ë'},
            {label:'–ü—Ä–æ –≤—ã—Å–æ—Ç—É', value:'–≤—ã—Å–æ—Ç–∞'},
            {label:'–ü—Ä–æ —Ç—É—Ä–±—É–ª–µ–Ω—Ç–Ω–æ—Å—Ç—å', value:'—Ç—É—Ä–±—É–ª–µ–Ω—Ç–Ω–æ—Å—Ç—å'}
          ]);
          return;
        }

        if (t.includes('—Ç—É—Ä–±—É–ª')){
          aeroSay('–ü—Ä–æ —Ç—É—Ä–±—É–ª–µ–Ω—Ç–Ω–æ—Å—Ç—å: –ø—Ä–∏—Å—Ç—ë–≥–Ω—É—Ç—ã–π —Ä–µ–º–µ–Ω—å ‚Äî –≥–ª–∞–≤–Ω–æ–µ. –ï—Å–ª–∏ —Ç—Ä—è—Å—ë—Ç, —ç–∫–∏–ø–∞–∂ –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å —ç—à–µ–ª–æ–Ω, —Å–∫–æ—Ä–æ—Å—Ç—å –∏ –æ–±—Ö–æ–¥–∏—Ç—å –∑–æ–Ω—ã –ø–æ –º–µ—Ç–µ–æ/–¥–æ–∫–ª–∞–¥–∞–º.', [
            {label:'–ï—â—ë —Ñ–∞–∫—Ç', value:'–µ—â—ë'},
            {label:'–ö–∞–∫ –≤—ã–±—Ä–∞—Ç—å –º–µ—Å—Ç–æ', value:'–º–µ—Å—Ç–æ'},
            {label:'–ó–∞–∫–æ–Ω—á–∏—Ç—å', value:'–∑–∞–∫–æ–Ω—á–∏—Ç—å'}
          ]);
          return;
        }

        if (t.includes('–º–µ—Å—Ç–æ')){
          aeroSay('–ï—Å–ª–∏ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã –∫ —Ç—Ä—è—Å–∫–µ, –æ–±—ã—á–Ω–æ –∫–æ–º—Ñ–æ—Ä—Ç–Ω–µ–µ –±–ª–∏–∂–µ –∫ –∫—Ä—ã–ª—É ‚Äî —Ç–∞–º –º–µ–Ω—å—à–µ ‚Äú—Ä—ã—á–∞–≥‚Äù –∫–æ–ª–µ–±–∞–Ω–∏–π. –£ –æ–∫–Ω–∞ –ø—Ä–æ—â–µ ‚Äú–∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å‚Äù –≤–∑–≥–ª—è–¥.', [
            {label:'–ï—â—ë —Ñ–∞–∫—Ç', value:'–µ—â—ë'},
            {label:'–ó–∞–∫–æ–Ω—á–∏—Ç—å', value:'–∑–∞–∫–æ–Ω—á–∏—Ç—å'}
          ]);
          return;
        }

        if (t.includes('–≤—ã—Å–æ—Ç')){
          aeroSay('–ü—Ä–æ –≤—ã—Å–æ—Ç—É: –Ω–∞ —ç—à–µ–ª–æ–Ω–µ –≤–æ–∑–¥—É—Ö —Ä–∞–∑—Ä–µ–∂–µ–Ω, –ø–æ—ç—Ç–æ–º—É –¥–≤–∏–≥–∞—Ç–µ–ª–∏ –∏ –∫—Ä—ã–ª–æ —Ä–∞–±–æ—Ç–∞—é—Ç –≤ –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö, –∞ –º–∞—Ä—à—Ä—É—Ç –∏ –≤—ã—Å–æ—Ç—ã –≤—ã–±–∏—Ä–∞—é—Ç —Å —É—á—ë—Ç–æ–º –ø–æ–≥–æ–¥—ã –∏ —Ç—Ä–∞—Ñ–∏–∫–∞.', [
            {label:'–ï—â—ë —Ñ–∞–∫—Ç', value:'–µ—â—ë'},
            {label:'–ü—Ä–æ —Å–∫–æ—Ä–æ—Å—Ç—å', value:'—Å–∫–æ—Ä–æ—Å—Ç—å'},
            {label:'–ó–∞–∫–æ–Ω—á–∏—Ç—å', value:'–∑–∞–∫–æ–Ω—á–∏—Ç—å'}
          ]);
          return;
        }

        if (t.includes('–∑–∞–∫–æ–Ω—á')){
          aeroSay('–û–∫–µ–π. –ï—Å–ª–∏ –∑–∞—Ö–æ—Ç–∏—Ç–µ ‚Äî –Ω–∞–∂–º–∏—Ç–µ ‚Äú+‚Äù –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–π —Å—Ü–µ–Ω–∞—Ä–∏–π.');
          state.activeFlow = null;
          state.step = null;
          state.data = {};
          return;
        }

        aeroSay('–°–∫–∞–∂–∏—Ç–µ ‚Äú–µ—â—ë‚Äù, –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É: —Å–∫–æ—Ä–æ—Å—Ç—å/–≤—ã—Å–æ—Ç–∞/—Ç—É—Ä–±—É–ª–µ–Ω—Ç–Ω–æ—Å—Ç—å.');
        return;
      }

      // ====== FLOW: CREW ======
      if (state.activeFlow === 'crew'){
        const t = normalize(trimmed);
        if (state.step === 'crewConfirm'){
          if (t === '–¥–∞' || t.includes('–≤—ã–∑–≤–∞—Ç—å') || t.includes('–¥–∞,')){
            state.step = 'crewDone';
            aeroSay(
              '–ü—Ä–∏–Ω—è—Ç–æ. –í –¥–µ–º–æ —è –æ—Ç–ø—Ä–∞–≤–ª—è—é ‚Äú–∑–∞–ø—Ä–æ—Å‚Äù.\n\n–ï—Å–ª–∏ —ç—Ç–æ —Ä–µ–∞–ª—å–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è: –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –≤—ã–∑–æ–≤–∞ –Ω–∞–¥ –∫—Ä–µ—Å–ª–æ–º –∏ –∫—Ä–∞—Ç–∫–æ —Å–æ–æ–±—â–∏—Ç–µ, —á—Ç–æ –Ω—É–∂–Ω–æ (–≤–æ–¥–∞/–ø–ª–µ–¥/–ø–æ–º–æ—â—å).'
            );
            state.activeFlow = null;
            state.step = null;
            state.data = {};
            return;
          }
          if (t === '–Ω–µ—Ç'){
            aeroSay('–û–∫–µ–π. –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –∏–∑–º–µ–Ω–∏—Ç—Å—è ‚Äî –ª—É—á—à–µ —Å—Ä–∞–∑—É –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É –≤—ã–∑–æ–≤–∞ –Ω–∞–¥ –∫—Ä–µ—Å–ª–æ–º.');
            state.activeFlow = null;
            state.step = null;
            state.data = {};
            return;
          }
          aeroSay('–û—Ç–≤–µ—Ç—å—Ç–µ ‚Äú–¥–∞‚Äù –∏–ª–∏ ‚Äú–Ω–µ—Ç‚Äù.', [
            {label:'–î–∞, –≤—ã–∑–≤–∞—Ç—å', value:'–¥–∞'},
            {label:'–ù–µ—Ç', value:'–Ω–µ—Ç'}
          ]);
          return;
        }
        aeroSay('–ï—Å–ª–∏ –Ω—É–∂–Ω–æ ‚Äî –Ω–∞–ø–∏—à–∏—Ç–µ ‚Äú—Å–≤—è–∑—å‚Äù, –∏ —è –ø–æ–≤—Ç–æ—Ä—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é.');
        return;
      }
    }

    function send(){
      const text = inputEl.value.trim();
      if (!text) return;
      inputEl.value = '';
      handleUserInput(text);
    }

    sendEl.addEventListener('click', send);
    inputEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') send();
    });

    window.addEventListener('load', () => {
      inputEl.focus();
      messagesEl.scrollTop = messagesEl.scrollHeight;
    });

    window.addEventListener('resize', () => {
      requestAnimationFrame(() => {
        messagesEl.scrollTop = messagesEl.scrollHeight;
      });
    });
  </script>
</body>
</html>


