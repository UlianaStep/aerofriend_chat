<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>–ê—ç—Ä–æ–¥—Ä—É–≥ ‚Äî —á–∞—Ç</title>

  <style>
    :root{
      --bgTop:#0b4f87;
      --bgMid:#083a6d;
      --bgBot:#062a55;

      --text:#fff;
      --muted:rgba(255,255,255,.70);

      --bubble-bot: rgba(255,255,255,.14);
      --bubble-user:#f28a2a;

      --stroke: rgba(255,255,255,.14);

      --input-bg: rgba(255,255,255,.16);
      --input-stroke: rgba(255,255,255,.16);

      --btn-bg: rgba(255,255,255,.10);
      --btn-stroke: rgba(255,255,255,.18);

      --overlay: rgba(0,0,0,.38);
      --panel: rgba(7, 40, 80, .92);
      --panel-stroke: rgba(255,255,255,.14);

      --radius:18px;

      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);

      --header-h: 88px;
      --composer-h: 92px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      color:var(--text);
      background: radial-gradient(1200px 900px at 35% 25%, var(--bgTop) 0%, var(--bgMid) 45%, var(--bgBot) 100%);
      overflow:hidden;
    }

    .app{ height:100%; display:flex; flex-direction:column; }

    header{
      height: calc(var(--header-h) + var(--safe-top));
      padding: calc(14px + var(--safe-top)) 18px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(0,0,0,.14), rgba(0,0,0,0));
      backdrop-filter: blur(6px);
    }

    .icon-btn{
      width:46px;height:46px;
      border-radius:16px;
      border:1px solid var(--btn-stroke);
      background: var(--btn-bg);
      display:grid;
      place-items:center;
      box-shadow: 0 10px 22px rgba(0,0,0,.18);
      cursor:pointer;
      padding:0;
    }
    .icon-btn img{ width:22px;height:22px; object-fit:contain; display:block; }

    .brand{ display:flex; align-items:center; }
    .brand img{ height:22px; width:auto; display:block; }

    .titlebar{ padding: 10px 20px 6px; }
    .titlebar h1{
      margin:0;
      font-size: 40px;
      font-weight: 800;
      letter-spacing:.2px;
      line-height:1.05;
    }

    .chat{
      flex:1;
      display:flex;
      flex-direction:column;
      min-height:0;
      padding: 0 16px;
      position:relative;
    }

    .messages{
      flex:1;
      min-height:0;
      overflow:auto;
      padding: 8px 0 14px;
      -webkit-overflow-scrolling: touch;
      scroll-behavior:smooth;
    }
    .messages::-webkit-scrollbar{ width:8px; }
    .messages::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,.18);
      border-radius: 10px;
    }

    .empty-hint{
      margin: 18px 0 0;
      padding: 14px 14px;
      border: 1px dashed rgba(255,255,255,.18);
      border-radius: 16px;
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.75);
      line-height: 1.35;
    }

    .msg{
      margin: 18px 0;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .msg.bot{ align-items:flex-start; }
    .msg.user{ align-items:flex-end; }

    .label{
      font-size: 11px;
      letter-spacing: .6px;
      text-transform: uppercase;
      color: rgba(255,255,255,.55);
      padding: 0 6px;
    }

    .bubble{
      max-width: 78%;
      padding: 14px 16px;
      border-radius: var(--radius);
      border: 1px solid var(--stroke);
      box-shadow: 0 10px 22px rgba(0,0,0,.14);
      backdrop-filter: blur(6px);
      line-height: 1.35;
      font-size: 16px;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .bot .bubble{
      background: var(--bubble-bot);
      border-bottom-left-radius: 10px;
    }

    .user .bubble{
      background: var(--bubble-user);
      border-color: rgba(255,255,255,.08);
      border-bottom-right-radius: 10px;
    }

    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      padding: 0 6px;
      margin-top: 4px;
    }
    .chip{
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.10);
      color: rgba(255,255,255,.92);
      border-radius: 14px;
      padding: 10px 12px;
      font-size: 14px;
      cursor:pointer;
      box-shadow: 0 10px 20px rgba(0,0,0,.12);
      user-select:none;
    }
    .chip:active{ transform: translateY(1px); }

    .composer{
      height: calc(var(--composer-h) + var(--safe-bottom));
      padding: 12px 16px calc(12px + var(--safe-bottom));
      display:flex;
      align-items:center;
      gap:12px;
      position:relative;
      z-index:3;
    }

    .plus{
      width:54px;height:54px;
      border-radius: 16px;
      border: 1px solid var(--btn-stroke);
      background: rgba(255,255,255,.10);
      display:grid;
      place-items:center;
      box-shadow: 0 10px 22px rgba(0,0,0,.18);
      cursor:pointer;
      padding:0;
    }
    .plus img{ width:22px;height:22px; display:block; }

    .input{
      flex:1;
      height:54px;
      border-radius: 18px;
      border: 1px solid var(--input-stroke);
      background: var(--input-bg);
      color: var(--text);
      outline:none;
      padding: 0 16px;
      font-size: 17px;
      box-shadow: 0 10px 22px rgba(0,0,0,.16);
    }
    .input::placeholder{ color: rgba(255,255,255,.70); }

    .send{
      width:56px;height:54px;
      border-radius: 18px;
      border:none;
      background: var(--bubble-user);
      box-shadow: 0 12px 24px rgba(0,0,0,.22);
      display:grid;
      place-items:center;
      cursor:pointer;
      padding:0;
    }
    .send img{ width:22px;height:22px; display:block; }

    /* ===== Quick Actions Popup ===== */
    .overlay{
      position:absolute;
      inset:0;
      background: var(--overlay);
      backdrop-filter: blur(4px);
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease;
      z-index:10;
    }
    .overlay.open{ opacity:1; pointer-events:auto; }

    .sheet{
      position:absolute;
      left: 16px;
      right: 16px;
      bottom: calc(var(--composer-h) + 10px + var(--safe-bottom));
      border-radius: 22px;
      border: 1px solid var(--panel-stroke);
      background: var(--panel);
      box-shadow: 0 24px 60px rgba(0,0,0,.28);
      padding: 14px;
      transform: translateY(10px);
      opacity:0;
      transition: transform .18s ease, opacity .18s ease;
    }
    .overlay.open .sheet{ transform: translateY(0); opacity:1; }

    .sheet-title{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      padding: 4px 4px 10px;
    }
    .sheet-title h2{
      margin:0;
      font-size: 28px;
      font-weight: 900;
      letter-spacing:.2px;
      color:#fff;
    }
    .sheet-title p{
      margin:6px 0 0;
      color: rgba(255,255,255,.78);
      font-size: 18px;
      line-height: 1.25;
    }
    .sheet-close{
      width:52px;height:52px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.08);
      color: rgba(255,255,255,.92);
      cursor:pointer;
      font-size: 30px;
      line-height: 1;
      display:grid;
      place-items:center;
    }

    .actions{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
      margin-top: 10px;
    }

    .action-card{
      width:100%;
      text-align:left;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.10);
      border-radius: 22px;
      padding: 16px 16px;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:12px;
      color:#fff;
    }
    .action-card:active{ transform: translateY(1px); }

    .action-main{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:0;
    }
    .action-name{
      font-weight: 900;
      font-size: 22px;
      line-height: 1.1;
      color:#fff;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .action-desc{
      font-size: 18px;
      color: rgba(255,255,255,.78);
      line-height: 1.2;
    }

    .crew-btn{
      margin-top: 14px;
      width:100%;
      border:none;
      border-radius: 22px;
      background: var(--bubble-user);
      color:#fff;
      font-weight: 900;
      letter-spacing:.2px;
      padding: 18px 14px;
      cursor:pointer;
      box-shadow: 0 14px 28px rgba(0,0,0,.22);
      font-size: 22px;
    }
    .crew-btn:active{ transform: translateY(1px); }

    @media (min-width: 820px) and (orientation: landscape){
      .app{ align-items:center; }
      header,.titlebar,.chat,.composer{ width: min(920px, 92vw); }
      .bubble{ max-width: 62%; }
      .titlebar h1{ font-size: 44px; }
      .sheet{ left: 0; right: 0; }
    }

    @media (max-width: 360px){
      .titlebar h1{ font-size: 36px; }
      .bubble{ font-size: 15px; }
      .sheet-title h2{ font-size: 22px; }
      .sheet-title p, .action-desc{ font-size: 15px; }
      .action-name{ font-size: 18px; }
      .crew-btn{ font-size: 18px; }
    }
  </style>
</head>

<body>
  <div class="app">
    <header>
      <button class="icon-btn" type="button" aria-label="–ú–µ–Ω—é">
        <img src="Icon/Burger-menu.svg" alt="" />
      </button>

      <div class="brand" aria-label="Aeroflot">
        <img src="Logo/CMYK.svg" alt="AEROFLOT" />
      </div>
    </header>

    <div class="titlebar">
      <h1>–ê—ç—Ä–æ–¥—Ä—É–≥</h1>
    </div>

    <main class="chat">
      <div id="messages" class="messages" role="log" aria-live="polite" aria-relevant="additions">
        <div id="emptyHint" class="empty-hint">
          –ù–∞–∂–º–∏—Ç–µ ¬´+¬ª –¥–ª—è —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –∏–ª–∏ –∑–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å ‚Äî —è –ø–æ–º–æ–≥—É –ø–æ —Ö–æ–¥—É –ø–æ–ª—ë—Ç–∞.
        </div>
      </div>

      <div id="overlay" class="overlay" aria-hidden="true">
        <div class="sheet" role="dialog" aria-label="–ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å –≤ –ø–æ–ª—ë—Ç–µ">
          <div class="sheet-title">
            <div>
              <h2>–ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å –≤ –ø–æ–ª—ë—Ç–µ</h2>
              <p>–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ü–µ–Ω–∞—Ä–∏–π ‚Äî —è –∑–∞–¥–∞–º –ø–∞—Ä—É –≤–æ–ø—Ä–æ—Å–æ–≤ –∏ –ø—Ä–µ–¥–ª–æ–∂—É –≤–∞—Ä–∏–∞–Ω—Ç.</p>
            </div>
            <button id="closeSheet" class="sheet-close" type="button" aria-label="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
          </div>

          <div class="actions">
            <button class="action-card" type="button" data-action="watch">
              <div class="action-main">
                <div class="action-name">üé¨ –ü–æ–¥–±–æ—Ä–∫–∞ –Ω–∞ —ç—Ç–æ—Ç —Ä–µ–π—Å</div>
                <div class="action-desc">–§–∏–ª—å–º –∏–ª–∏ —Å–µ—Ä–∏–∞–ª –ø–æ–¥ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ–ª—ë—Ç–∞ –∏ –≤–∫—É—Å.</div>
              </div>
            </button>

            <button class="action-card" type="button" data-action="sleep">
              <div class="action-main">
                <div class="action-name">üåô –ú—è–≥–∫–æ —É—Å–Ω—É—Ç—å</div>
                <div class="action-desc">–î—ã—Ö–∞–Ω–∏–µ, —Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–∏–µ –∏ ‚Äú–≤—ã–∫–ª—é—á–µ–Ω–∏–µ –≥–æ–ª–æ–≤—ã‚Äù.</div>
              </div>
            </button>

            <button class="action-card" type="button" data-action="flyover">
              <div class="action-main">
                <div class="action-name">üó∫Ô∏è –ß—Ç–æ –º—ã –ø—Ä–æ–ª–µ—Ç–∞–µ–º</div>
                <div class="action-desc">–ü–æ–¥—Å–∫–∞–∂—É –æ—Ä–∏–µ–Ω—Ç–∏—Ä—ã –ø–æ –º–∞—Ä—à—Ä—É—Ç—É.</div>
              </div>
            </button>

            <button class="action-card" type="button" data-action="aircraft">
              <div class="action-main">
                <div class="action-name">‚úàÔ∏è –ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ–µ –æ —Å–∞–º–æ–ª—ë—Ç–µ</div>
                <div class="action-desc">–§–∞–∫—Ç—ã –ø—Ä–æ –ø–æ–ª—ë—Ç, –≤—ã—Å–æ—Ç—É, —Å–∫–æ—Ä–æ—Å—Ç—å –∏ —Å–∏—Å—Ç–µ–º—ã.</div>
              </div>
            </button>
          </div>

          <button id="crewBtn" class="crew-btn" type="button">
            –°–≤—è–∑—å —Å –±–æ—Ä—Ç–ø—Ä–æ–≤–æ–¥–Ω–∏–∫–æ–º
          </button>
        </div>
      </div>

      <div class="composer">
        <button id="plus" class="plus" type="button" aria-label="–°—Ü–µ–Ω–∞—Ä–∏–∏">
          <img src="Icon/Plus.svg" alt="" />
        </button>

        <input id="input" class="input" type="text" placeholder="–°–ø—Ä–æ—Å–∏ –º–µ–Ω—è" autocomplete="off" />

        <button id="send" class="send" type="button" aria-label="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">
          <img src="Icon/TextButton/arrow-up_20x20.svg" alt="" />
        </button>
      </div>
    </main>
  </div>

  <script>
    const messagesEl = document.getElementById('messages');
    const emptyHintEl = document.getElementById('emptyHint');
    const inputEl = document.getElementById('input');
    const sendEl = document.getElementById('send');

    const plusEl = document.getElementById('plus');
    const overlayEl = document.getElementById('overlay');
    const closeSheetEl = document.getElementById('closeSheet');
    const crewBtnEl = document.getElementById('crewBtn');

    // ====== –°–æ—Å—Ç–æ—è–Ω–∏–µ ======
    let state = {
      activeFlow: null,  // null | watch | sleep | flyover | aircraft | crew
      step: null,
      data: {}
    };

    function normalize(s){
      return (s || '').toLowerCase().replace(/—ë/g,'–µ').trim();
    }

    function hideEmptyHint(){
      if (emptyHintEl) emptyHintEl.style.display = 'none';
    }

    function addMessage({from, text, chips}){
      hideEmptyHint();

      const msg = document.createElement('div');
      msg.className = `msg ${from}`;

      const label = document.createElement('div');
      label.className = 'label';
      label.textContent = (from === 'bot') ? '–ê–≠–†–û–î–†–£–ì' : '–í—ã';

      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.textContent = text;

      msg.appendChild(label);
      msg.appendChild(bubble);

      if (Array.isArray(chips) && chips.length){
        const chipsWrap = document.createElement('div');
        chipsWrap.className = 'chips';

        for (const c of chips){
          const b = document.createElement('button');
          b.className = 'chip';
          b.type = 'button';
          b.textContent = c.label;

          // –í–ê–ñ–ù–û: –≤ —á–∞—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ–º label, –∞ value –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ
          b.addEventListener('click', () => {
            handleUserInput(c.label, true, c.value);
          });

          chipsWrap.appendChild(b);
        }
        msg.appendChild(chipsWrap);
      }

      messagesEl.appendChild(msg);
      requestAnimationFrame(() => {
        messagesEl.scrollTop = messagesEl.scrollHeight;
      });
    }

    function aeroSay(text, chips){ addMessage({from:'bot', text, chips}); }
    function userSay(text){ addMessage({from:'user', text}); }

    function errorPickFromList(chips){
      aeroSay('–ü—Ä–æ—Å—Ç–∏—Ç–µ, –Ω–µ –ø–æ–Ω—è–ª, —á—Ç–æ –≤—ã –∏–º–µ–ª–∏ –≤–≤–∏–¥—É. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑ —Å–ø–∏—Å–∫–∞', chips || []);
    }

    function openSheet(){
      overlayEl.classList.add('open');
      overlayEl.setAttribute('aria-hidden','false');
    }
    function closeSheet(){
      overlayEl.classList.remove('open');
      overlayEl.setAttribute('aria-hidden','true');
    }

    plusEl.addEventListener('click', () => {
      if (overlayEl.classList.contains('open')) closeSheet();
      else openSheet();
    });
    closeSheetEl.addEventListener('click', closeSheet);
    overlayEl.addEventListener('click', (e) => {
      if (e.target === overlayEl) closeSheet();
    });

    overlayEl.querySelectorAll('[data-action]').forEach(btn => {
      btn.addEventListener('click', () => {
        const action = btn.getAttribute('data-action');
        closeSheet();
        startFlow(action);
      });
    });
    crewBtnEl.addEventListener('click', () => {
      closeSheet();
      startFlow('crew');
    });

    // ===== Watch Library (–≥–æ—Ç–æ–≤—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã) =====
    const watchLibrary = {
      short: {
        comedy: {
          film: ['The Grand Budapest Hotel', 'Palm Springs', 'Paddington'],
          series: ['The Office (US) ‚Äî 2‚Äì3 —Å–µ—Ä–∏–∏', 'Modern Family ‚Äî 3‚Äì4 —Å–µ—Ä–∏–∏', 'Brooklyn Nine-Nine ‚Äî 3‚Äì4 —Å–µ—Ä–∏–∏']
        },
        detective: {
          film: ['Knives Out', 'Sherlock Holmes (2009)', 'Gone Girl'],
          series: ['Sherlock ‚Äî 1 —Å–µ—Ä–∏—è', 'Only Murders in the Building ‚Äî 2‚Äì3 —Å–µ—Ä–∏–∏', 'Broadchurch ‚Äî 2 —Å–µ—Ä–∏–∏']
        },
        drama: {
          film: ['Whiplash', 'The Truman Show', 'Little Miss Sunshine'],
          series: ['The Bear ‚Äî 2‚Äì3 —Å–µ—Ä–∏–∏', 'Fleabag ‚Äî 3‚Äì4 —Å–µ—Ä–∏–∏', 'The Queen‚Äôs Gambit ‚Äî 1 —Å–µ—Ä–∏—è']
        },
        scifi: {
          film: ['Source Code', 'Edge of Tomorrow', 'Her'],
          series: ['Black Mirror ‚Äî 1 —Å–µ—Ä–∏—è', 'Love, Death & Robots ‚Äî –º–∏–Ω–∏-—ç–ø–∏–∑–æ–¥—ã', 'Stranger Things ‚Äî 1‚Äì2 —Å–µ—Ä–∏–∏']
        }
      },
      mid: {
        comedy: {
          film: ['The Intern', 'Free Guy', 'Chef'],
          series: ['Ted Lasso ‚Äî 2‚Äì4 —Å–µ—Ä–∏–∏', 'Friends ‚Äî 4‚Äì6 —Å–µ—Ä–∏–π', 'HIMYM ‚Äî 4‚Äì6 —Å–µ—Ä–∏–π']
        },
        detective: {
          film: ['Prisoners', 'Zodiac', 'Gone Girl'],
          series: ['Mindhunter ‚Äî 2‚Äì3 —Å–µ—Ä–∏–∏', 'Mare of Easttown ‚Äî 2 —Å–µ—Ä–∏–∏', 'Broadchurch ‚Äî 3 —Å–µ—Ä–∏–∏']
        },
        drama: {
          film: ['The Social Network', 'Arrival', 'La La Land'],
          series: ['The Queen‚Äôs Gambit ‚Äî 2 —Å–µ—Ä–∏–∏', 'Severance ‚Äî 2 —Å–µ—Ä–∏–∏', 'The Crown ‚Äî 2 —Å–µ—Ä–∏–∏']
        },
        scifi: {
          film: ['Ex Machina', 'The Martian', 'Arrival'],
          series: ['The Expanse ‚Äî 2‚Äì3 —Å–µ—Ä–∏–∏', 'Dark ‚Äî 1‚Äì2 —Å–µ—Ä–∏–∏', 'Westworld ‚Äî 1‚Äì2 —Å–µ—Ä–∏–∏']
        }
      },
      long: {
        comedy: {
          film: ['Forrest Gump', 'The Wolf of Wall Street', 'The Big Lebowski'],
          series: ['The Office ‚Äî 6‚Äì8 —Å–µ—Ä–∏–π', 'Modern Family ‚Äî 6‚Äì8 —Å–µ—Ä–∏–π', 'Ted Lasso ‚Äî 5‚Äì6 —Å–µ—Ä–∏–π']
        },
        detective: {
          film: ['The Godfather', 'The Irishman', 'Se7en'],
          series: ['True Detective ‚Äî 4‚Äì5 —Å–µ—Ä–∏–π', 'Broadchurch ‚Äî 5‚Äì6 —Å–µ—Ä–∏–π', 'Mindhunter ‚Äî 4‚Äì5 —Å–µ—Ä–∏–π']
        },
        drama: {
          film: ['Oppenheimer', 'Dune (2021)', 'Interstellar'],
          series: ['The Crown ‚Äî 4‚Äì5 —Å–µ—Ä–∏–π', 'Severance ‚Äî 4‚Äì5 —Å–µ—Ä–∏–π', 'The Queen‚Äôs Gambit ‚Äî 3‚Äì4 —Å–µ—Ä–∏–∏']
        },
        scifi: {
          film: ['Interstellar', 'Dune (2021)', 'Blade Runner 2049'],
          series: ['The Expanse ‚Äî 5‚Äì6 —Å–µ—Ä–∏–π', 'Dark ‚Äî 4 —Å–µ—Ä–∏–∏', 'Westworld ‚Äî 4‚Äì5 —Å–µ—Ä–∏–π']
        }
      }
    };

    function parseDuration(text){
      const t = normalize(text);
      if (t.startsWith('~')) return t;

      const hm = t.match(/^(\d{1,2})\s*:\s*(\d{1,2})$/);
      if (hm){
        const h = parseInt(hm[1],10);
        const m = parseInt(hm[2],10);
        if (!isNaN(h) && !isNaN(m)) return (h*60 + m);
      }
      const min = t.match(/(\d{1,4})\s*(–º–∏–Ω|–º)\b/);
      if (min){
        const m = parseInt(min[1],10);
        if (!isNaN(m)) return m;
      }
      const hr = t.match(/(\d{1,2})\s*(—á|—á–∞—Å)/);
      if (hr){
        const h = parseInt(hr[1],10);
        if (!isNaN(h)) return (h*60);
      }
      return null;
    }

    function durationToBucket(d){
      if (typeof d === 'string'){
        if (d.includes('~1—á') || d.includes('~1-2')) return 'short';
        if (d.includes('~2-4')) return 'mid';
        if (d.includes('~4+')) return 'long';
        return 'mid';
      }
      if (typeof d === 'number'){
        if (d <= 90) return 'short';
        if (d <= 160) return 'mid';
        return 'long';
      }
      return 'mid';
    }

    function genreToKey(g){
      const t = normalize(g);
      if (t.includes('–∫–æ–º–µ–¥')) return 'comedy';
      if (t.includes('–¥–µ—Ç–µ–∫—Ç') || t.includes('—Ç—Ä–∏–ª') || t.includes('–ø–æ–∂–µ—Å—Ç') || t.includes('–ø–æ–∂—ë—Å—Ç')) return 'detective';
      if (t.includes('–¥—Ä–∞–º')) return 'drama';
      if (t.includes('—Ñ–∞–Ω—Ç–∞—Å—Ç') || t.includes('sci') || t.includes('—Ñ—ç–Ω—Ç')) return 'scifi';
      return null;
    }

    function formatToKey(f){
      const t = normalize(f);
      if (t.includes('—Å–µ—Ä–∏–∞–ª') || t.includes('–º–∏–Ω–∏') || t.includes('—ç–ø–∏–∑')) return 'series';
      if (t.includes('—Ñ–∏–ª—å–º') || t.includes('–∫–∏–Ω–æ')) return 'film';
      return null;
    }

    function buildWatchResult(bucket, genreKey, formatKey){
      const list = (watchLibrary[bucket] && watchLibrary[bucket][genreKey] && watchLibrary[bucket][genreKey][formatKey]) || [];
      const bucketName = (bucket === 'short' ? '–∫–æ—Ä–æ—Ç–∫–∏–π' : bucket === 'mid' ? '—Å—Ä–µ–¥–Ω–∏–π' : '–¥–ª–∏–Ω–Ω—ã–π');
      return `–ü–æ–¥–±–æ—Ä–∫–∞ (${bucketName} —Å–ª–æ—Ç):\n‚Ä¢ ${list.join('\n‚Ä¢ ')}`;
    }

    // ===== Flyover: –ö–∞–∑–∞–Ω—å ‚Üí –ú–æ—Å–∫–≤–∞ =====
    function parseMinutesLoose(text){
      const t = normalize(text);
      const hm = t.match(/^(\d{1,2})\s*:\s*(\d{1,2})$/);
      if (hm){
        const h = parseInt(hm[1],10);
        const m = parseInt(hm[2],10);
        if (!isNaN(h) && !isNaN(m)) return (h*60 + m);
      }
      const min = t.match(/(\d{1,4})\s*(–º–∏–Ω|–º)\b/);
      if (min){
        const m = parseInt(min[1],10);
        if (!isNaN(m)) return m;
      }
      const hr = t.match(/(\d{1,2})\s*(—á|—á–∞—Å)/);
      if (hr){
        const h = parseInt(hr[1],10);
        if (!isNaN(h)) return h*60;
      }
      return null;
    }

    function flyoverAnswer(minutesFromTakeoff){
      if (minutesFromTakeoff == null){
        return `–ú–∞—Ä—à—Ä—É—Ç: –ö–∞–∑–∞–Ω—å ‚Üí –ú–æ—Å–∫–≤–∞.\n–°–∫–∞–∂–∏—Ç–µ, —Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç –ø—Ä–æ—à–ª–æ —Å –≤–∑–ª—ë—Ç–∞ ‚Äî –ø–æ–¥—Å–∫–∞–∂—É –æ—Ä–∏–µ–Ω—Ç–∏—Ä—ã.`;
      }
      if (minutesFromTakeoff <= 15){
        return `–ö–∞–∑–∞–Ω—å ‚Üí –ú–æ—Å–∫–≤–∞.\n–°–µ–π—á–∞—Å –æ–±—ã—á–Ω–æ –µ—â—ë –¢–∞—Ç–∞—Ä—Å—Ç–∞–Ω: –∏–∑–≥–∏–±—ã –í–æ–ª–≥–∏/–ö–∞–º—ã, –ø–æ–ª—è –∏ –ø—Ä–∏–≥–æ—Ä–æ–¥–Ω—ã–µ —Ä–∞–π–æ–Ω—ã.`;
      }
      if (minutesFromTakeoff <= 35){
        return `–ö–∞–∑–∞–Ω—å ‚Üí –ú–æ—Å–∫–≤–∞.\n–ß–∞—Å—Ç–æ –≤ —ç—Ç–æ–º –æ–∫–Ω–µ –ø–æ–¥ –∫—Ä—ã–ª–æ–º —Ä–∞–π–æ–Ω—ã –ß—É–≤–∞—à–∏–∏/–ú–∞—Ä–∏–π –≠–ª.\n–û—Ä–∏–µ–Ω—Ç–∏—Ä—ã: –ß–µ–±–æ–∫—Å–∞—Ä—ã, –ô–æ—à–∫–∞—Ä-–û–ª–∞, —à–∏—Ä–æ–∫–∞—è –í–æ–ª–≥–∞.`;
      }
      if (minutesFromTakeoff <= 60){
        return `–ö–∞–∑–∞–Ω—å ‚Üí –ú–æ—Å–∫–≤–∞.\n–°–µ—Ä–µ–¥–∏–Ω–∞ –º–∞—Ä—à—Ä—É—Ç–∞: –Ω–µ—Ä–µ–¥–∫–æ –ù–∏–∂–µ–≥–æ—Ä–æ–¥—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å.\n–û—Ä–∏–µ–Ω—Ç–∏—Ä—ã: –ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥, —Å–ª–∏—è–Ω–∏–µ –í–æ–ª–≥–∏ –∏ –û–∫–∏, –∫—Ä—É–ø–Ω—ã–µ –º–æ—Å—Ç—ã –∏ –ø–µ—Ç–ª–∏ —Ä–µ–∫.`;
      }
      if (minutesFromTakeoff <= 85){
        return `–ö–∞–∑–∞–Ω—å ‚Üí –ú–æ—Å–∫–≤–∞.\n–ë–ª–∏–∂–µ –∫ —Ñ–∏–Ω–∞–ª—É —á–∞—Å—Ç–æ –í–ª–∞–¥–∏–º–∏—Ä—Å–∫–∞—è/–ú–æ—Å–∫–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç–∏.\n–û—Ä–∏–µ–Ω—Ç–∏—Ä—ã: –í–ª–∞–¥–∏–º–∏—Ä, –¥–∞–ª–µ–µ –ø–ª–æ—Ç–Ω–∞—è —Å–µ—Ç–∫–∞ –¥–æ—Ä–æ–≥ –∏ –Ω–∞—Å–µ–ª—ë–Ω–Ω—ã—Ö –ø—É–Ω–∫—Ç–æ–≤.`;
      }
      return `–ö–∞–∑–∞–Ω—å ‚Üí –ú–æ—Å–∫–≤–∞.\n–ï—Å–ª–∏ –±–æ–ª—å—à–µ ~1:25 –ø–æ—Å–ª–µ –≤–∑–ª—ë—Ç–∞, –≤–µ—Ä–æ—è—Ç–Ω–æ –∑–æ–Ω–∞ —Å–Ω–∏–∂–µ–Ω–∏—è.\n–û—Ä–∏–µ–Ω—Ç–∏—Ä—ã: –ø–ª–æ—Ç–Ω–∞—è –∑–∞—Å—Ç—Ä–æ–π–∫–∞, –º–∞–≥–∏—Å—Ç—Ä–∞–ª–∏, –≤–æ–¥–æ—ë–º—ã –∏ —Ä–µ–∫–∞ –ú–æ—Å–∫–≤–∞.`;
    }

    // ===== –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ —Å–ø–∏—Å–∫–∏ —á–∏–ø–æ–≤ =====
    const chipsDuration = [
      {label:'–î–æ 1 —á–∞—Å–∞', value:'~1—á'},
      {label:'1‚Äì2 —á–∞—Å–∞', value:'~1-2—á'},
      {label:'2‚Äì4 —á–∞—Å–∞', value:'~2-4—á'},
      {label:'–ë–æ–ª—å—à–µ 4 —á–∞—Å–æ–≤', value:'~4+—á'}
    ];

    const chipsGenre = [
      {label:'–ö–æ–º–µ–¥–∏—è', value:'genre:comedy'},
      {label:'–î–µ—Ç–µ–∫—Ç–∏–≤/—Ç—Ä–∏–ª–ª–µ—Ä', value:'genre:detective'},
      {label:'–î—Ä–∞–º–∞', value:'genre:drama'},
      {label:'–§–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞', value:'genre:scifi'}
    ];

    const chipsFormat = [
      {label:'–°–µ—Ä–∏–∞–ª', value:'format:series'},
      {label:'–§–∏–ª—å–º', value:'format:film'}
    ];

    const chipsCrew = [
      {label:'–ü—Ä–∏–Ω–µ—Å–∏—Ç–µ –≤–æ–¥—É', value:'crew:water'},
      {label:'–ù—É–∂–Ω–∞ –ø–æ–¥—É—à–∫–∞', value:'crew:pillow'},
      {label:'–ó–∞–∫–∞–∂–∏—Ç–µ —É–∂–∏–Ω', value:'crew:dinner'},
      {label:'–ü—Ä–∏–Ω–µ—Å–∏—Ç–µ –¥–µ—Ç—Å–∫–æ–µ –º–µ–Ω—é', value:'crew:kids'}
    ];

    // ===== Intent router (–≥–ª–æ–±–∞–ª—å–Ω—ã–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã) =====
    function detectGlobalIntent(text){
      const t = normalize(text);

      // crew
      if (t.includes('–≤–æ–¥—É')) return {flow:'crew', internal:'crew:water', display:'–ü—Ä–∏–Ω–µ—Å–∏—Ç–µ –≤–æ–¥—É'};
      if (t.includes('–ø–æ–¥—É—à')) return {flow:'crew', internal:'crew:pillow', display:'–ù—É–∂–Ω–∞ –ø–æ–¥—É—à–∫–∞'};
      if (t.includes('—É–∂–∏–Ω')) return {flow:'crew', internal:'crew:dinner', display:'–ó–∞–∫–∞–∂–∏—Ç–µ —É–∂–∏–Ω'};
      if (t.includes('–¥–µ—Ç—Å–∫') && (t.includes('–º–µ–Ω—é') || t.includes('–¥–µ—Ç—Å–∫–æ–µ'))) return {flow:'crew', internal:'crew:kids', display:'–ü—Ä–∏–Ω–µ—Å–∏—Ç–µ –¥–µ—Ç—Å–∫–æ–µ –º–µ–Ω—é'};
      if (t.includes('–±–æ—Ä—Ç–ø—Ä–æ–≤–æ–¥') || t.includes('–ø—Ä–æ–≤–æ–¥–Ω–∏–∫')) return {flow:'crew'};

      // flyover
      if (t.includes('—á—Ç–æ –º—ã –ø—Ä–æ–ª–µ—Ç–∞') || t.includes('—á—Ç–æ –ø—Ä–æ–ª–µ—Ç–∞') || t.includes('–≥–¥–µ –ª–µ—Ç–∏–º') || t.includes('–Ω–∞–¥ —á–µ–º')) return {flow:'flyover'};

      // sleep
      if (t.includes('—É—Å–Ω—É—Ç—å') || t.includes('—Å–æ–Ω') || t.includes('–∑–∞—Å—ã–ø')) return {flow:'sleep'};

      // aircraft facts
      if (t.includes('—Å–∞–º–æ–ª–µ—Ç') || t.includes('—Å–∞–º–æ–ª—ë—Ç') || t.includes('—Ç—É—Ä–±—É–ª') || t.includes('—Å–∫–æ—Ä–æ—Å—Ç') || t.includes('–≤—ã—Å–æ—Ç')) return {flow:'aircraft'};

      // watch
      if (t.includes('—á—Ç–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å') || t.includes('–ø–æ—Å–æ–≤–µ—Ç—É–π') || t.includes('–∫–∏–Ω–æ') || t.includes('—Ñ–∏–ª—å–º') || t.includes('—Å–µ—Ä–∏–∞–ª')) return {flow:'watch'};

      // genre/format refiners as triggers (even if user just writes "–¥–µ—Ç–µ–∫—Ç–∏–≤", "–ø–æ–∂–µ—Å—Ç—á–µ")
      if (genreToKey(t)) return {flow:'watch', pre:{genreKey: genreToKey(t)}};
      if (t.includes('–ø–æ–∂–µ—Å—Ç') || t.includes('–ø–æ–∂—ë—Å—Ç')) return {flow:'watch', pre:{genreKey:'detective'}};

      return null;
    }

    // ====== –°—Ç–∞—Ä—Ç —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ ======
    function startFlow(flow, pre=null){
      state.activeFlow = flow;
      state.step = null;
      state.data = Object.assign({}, pre || {});

      switch(flow){
        case 'watch':
          state.step = 'askDuration';
          aeroSay(
            '–ü–æ–¥–±–µ—Ä—É, —á—Ç–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å. –°–∫–æ–ª—å–∫–æ –ø—Ä–∏–º–µ—Ä–Ω–æ –ª–µ—Ç–µ—Ç—å? –ú–æ–∂–Ω–æ ‚Äú2:30‚Äù –∏–ª–∏ ‚Äú150 –º–∏–Ω—É—Ç‚Äù.',
            chipsDuration
          );
          break;

        case 'sleep':
          state.step = 'sleepIntro';
          aeroSay(
            '–°–¥–µ–ª–∞–µ–º —Å–ø–æ–∫–æ–π–Ω—ã–π ‚Äú—Å–ø—É—Å–∫‚Äù –≤ —Å–æ–Ω. –°–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏ –µ—Å—Ç—å?',
            [
              {label:'5 –º–∏–Ω—É—Ç', value:'sleep:5'},
              {label:'10 –º–∏–Ω—É—Ç', value:'sleep:10'},
              {label:'–ü—Ä–æ—Å—Ç–æ —Å–æ–≤–µ—Ç—ã', value:'sleep:tips'}
            ]
          );
          break;

        case 'flyover':
          state.step = 'flyoverAskTime';
          state.data.route = '–ö–∞–∑–∞–Ω—å ‚Üí –ú–æ—Å–∫–≤–∞';
          aeroSay('–ú–∞—Ä—à—Ä—É—Ç: –ö–∞–∑–∞–Ω—å ‚Üí –ú–æ—Å–∫–≤–∞. –°–∫–æ–ª—å–∫–æ –ø—Ä–æ—à–ª–æ —Å –≤–∑–ª—ë—Ç–∞? (–Ω–∞–ø—Ä–∏–º–µ—Ä: ‚Äú20 –º–∏–Ω—É—Ç‚Äù –∏–ª–∏ ‚Äú0:45‚Äù)');
          break;

        case 'aircraft':
          state.step = 'aircraftFact';
          aeroSay(
            '–ö–æ—Ä–æ—Ç–∫–∏–π —Ñ–∞–∫—Ç: –Ω–∞ –∫—Ä–µ–π—Å–µ—Ä—Å–∫–æ–º —Ä–µ–∂–∏–º–µ –ª–∞–π–Ω–µ—Ä –æ–±—ã—á–Ω–æ –ª–µ—Ç–∏—Ç –Ω–∞ –≤—ã—Å–æ—Ç–µ –æ–∫–æ–ª–æ 10‚Äì12 –∫–º ‚Äî —ç—Ç–æ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ –ø–æ —Ä–∞—Å—Ö–æ–¥—É —Ç–æ–ø–ª–∏–≤–∞ –∏ –ø–æ–≥–æ–¥–µ.',
            [
              {label:'–ï—â—ë —Ñ–∞–∫—Ç', value:'air:more'},
              {label:'–ü—Ä–æ —Å–∫–æ—Ä–æ—Å—Ç—å', value:'air:speed'},
              {label:'–ü—Ä–æ —Ç—É—Ä–±—É–ª–µ–Ω—Ç–Ω–æ—Å—Ç—å', value:'air:turb'}
            ]
          );
          break;

        case 'crew':
          state.step = 'crewPick';
          aeroSay('–ß—Ç–æ –ø–µ—Ä–µ–¥–∞—Ç—å –±–æ—Ä—Ç–ø—Ä–æ–≤–æ–¥–Ω–∏–∫—É?', chipsCrew);
          break;
      }
    }

    // ====== –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ ======
    // text: —Ç–æ, —á—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤ –æ—Ä–∞–Ω–∂–µ–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
    // internalValue: –º–∞—à–∏–Ω–Ω—ã–π value (–¥–ª—è —á–∏–ø–æ–≤)
    function handleUserInput(text, fromChip=false, internalValue=null){
      const trimmed = (text || '').trim();
      if (!trimmed) return;

      // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ human-—Ç–µ–∫—Å—Ç (label), –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º crew:water
      userSay(trimmed);

      const tNorm = normalize(trimmed);

      // 1) –ï—Å–ª–∏ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è ‚Äî –ø—Ä–æ–±—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã
      if (!state.activeFlow){
        const intent = detectGlobalIntent(trimmed);
        if (intent){
          startFlow(intent.flow, intent.pre || null);

          // –µ—Å–ª–∏ intent –≤–∫–ª—é—á–∞–µ—Ç –º–æ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π –≤—ã–±–æ—Ä (–Ω–∞–ø—Ä–∏–º–µ—Ä "–≤–æ–¥—É")
          if (intent.internal){
            // —Å–∏–º—É–ª–∏—Ä—É–µ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –≤—ã–±–æ—Ä –±–µ–∑ –≤—ã–≤–æ–¥–∞ crew:water –≤ —á–∞—Ç
            processInternal(intent.internal, intent.display || trimmed);
          }
          return;
        }

        // –Ω–µ –ø–æ–Ω—è–ª–∏ –≤–æ–æ–±—â–µ
        errorPickFromList([
          {label:'üé¨ –ü–æ–¥–±–æ—Ä–∫–∞ –Ω–∞ —Ä–µ–π—Å', value:'start:watch'},
          {label:'üåô –ú—è–≥–∫–æ —É—Å–Ω—É—Ç—å', value:'start:sleep'},
          {label:'üó∫Ô∏è –ß—Ç–æ –º—ã –ø—Ä–æ–ª–µ—Ç–∞–µ–º', value:'start:flyover'},
          {label:'‚úàÔ∏è –ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ–µ –æ —Å–∞–º–æ–ª—ë—Ç–µ', value:'start:aircraft'},
          {label:'–°–≤—è–∑—å —Å –±–æ—Ä—Ç–ø—Ä–æ–≤–æ–¥–Ω–∏–∫–æ–º', value:'start:crew'}
        ]);
        return;
      }

      // 2) –ï—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π ‚Äî —Å–Ω–∞—á–∞–ª–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º internalValue (—á–∏–ø—ã)
      if (internalValue){
        processInternal(internalValue, trimmed);
        return;
      }

      // 3) –ó–∞—Ç–µ–º ‚Äî —Ç–µ–∫—Å—Ç–æ–≤—ã–π –≤–≤–æ–¥ –∫–∞–∫ —Ç—Ä–∏–≥–≥–µ—Ä—ã –≤–Ω—É—Ç—Ä–∏ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
      // (–ø—Ä–∏–º–µ—Ä: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç "–¥–µ—Ç–µ–∫—Ç–∏–≤" –∏–ª–∏ "–ø–æ–∂–µ—Å—Ç—á–µ")
      const innerIntent = detectGlobalIntent(trimmed);
      if (innerIntent && innerIntent.flow && innerIntent.flow !== state.activeFlow){
        // —Ä–∞–∑—Ä–µ—à–∞–µ–º –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è
        startFlow(innerIntent.flow, innerIntent.pre || null);
        if (innerIntent.internal){
          processInternal(innerIntent.internal, innerIntent.display || trimmed);
        }
        return;
      }

      // 4) –ï—Å–ª–∏ —Ç—Ä–∏–≥–≥–µ—Ä –ø–æ–ø–∞–¥–∞–µ—Ç –≤ —Ç–µ–∫—É—â–∏–π flow (–Ω–∞–ø—Ä–∏–º–µ—Ä "–¥–µ—Ç–µ–∫—Ç–∏–≤" –≤–Ω—É—Ç—Ä–∏ watch)
      if (state.activeFlow === 'watch'){
        handleWatchText(trimmed);
        return;
      }

      if (state.activeFlow === 'sleep'){
        handleSleepText(trimmed);
        return;
      }

      if (state.activeFlow === 'flyover'){
        handleFlyoverText(trimmed);
        return;
      }

      if (state.activeFlow === 'aircraft'){
        handleAircraftText(trimmed);
        return;
      }

      if (state.activeFlow === 'crew'){
        handleCrewText(trimmed);
        return;
      }
    }

    function processInternal(value, displayText){
      // –æ–±—â–∏–µ –∫–æ–º–∞–Ω–¥—ã —Å—Ç–∞—Ä—Ç–∞ –∏–∑ –æ—à–∏–±–∫–∏
      if (value.startsWith('start:')){
        const flow = value.split(':')[1];
        startFlow(flow);
        return;
      }

      // watch internals
      if (value === '~1—á' || value === '~1-2—á' || value === '~2-4—á' || value === '~4+—á'){
        if (state.activeFlow === 'watch' && state.step === 'askDuration'){
          state.data.duration = value;
          state.data.bucket = durationToBucket(value);
          state.step = 'askGenre';

          // –µ—Å–ª–∏ –∂–∞–Ω—Ä —É–∂–µ –ø—Ä–µ–¥–≤—ã–±—Ä–∞–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤—ë–ª "–¥–µ—Ç–µ–∫—Ç–∏–≤" –µ—â—ë –¥–æ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏)
          if (state.data.genreKey){
            aeroSay('–ñ–∞–Ω—Ä –ø–æ–Ω—è–ª. –§–æ—Ä–º–∞—Ç: —Å–µ—Ä–∏–∞–ª –∏–ª–∏ —Ñ–∏–ª—å–º?', chipsFormat);
            state.step = 'askFormat';
          } else {
            aeroSay('–û–∫–µ–π. –ö–∞–∫–æ–π –∂–∞–Ω—Ä –±–µ—Ä—ë–º?', chipsGenre);
          }
          return;
        }
      }

      if (value.startsWith('genre:')){
        if (state.activeFlow === 'watch'){
          state.data.genreKey = value.split(':')[1];
          state.step = 'askFormat';
          aeroSay('–§–æ—Ä–º–∞—Ç: —Å–µ—Ä–∏–∞–ª –∏–ª–∏ —Ñ–∏–ª—å–º?', chipsFormat);
          return;
        }
      }

      if (value.startsWith('format:')){
        if (state.activeFlow === 'watch'){
          state.data.formatKey = value.split(':')[1];
          showWatchResult();
          return;
        }
      }

      // sleep internals
      if (value === 'sleep:5'){
        if (state.activeFlow === 'sleep'){
          state.step = 'sleep5';
          aeroSay(
            '5 –º–∏–Ω—É—Ç:\n1) –í–¥–æ—Ö 4 —Å–µ–∫—É–Ω–¥—ã.\n2) –í—ã–¥–æ—Ö 6 —Å–µ–∫—É–Ω–¥.\n–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ 8 —Ü–∏–∫–ª–æ–≤.\n\n–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –µ—â—ë 2 –º–∏–Ω—É—Ç—ã?',
            [
              {label:'–î–∞, –µ—â—ë 2', value:'sleep:more2'},
              {label:'–ù–µ—Ç, –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ', value:'sleep:done'}
            ]
          );
          return;
        }
      }
      if (value === 'sleep:10'){
        if (state.activeFlow === 'sleep'){
          state.step = 'sleep10';
          aeroSay('10 –º–∏–Ω—É—Ç: —Ö–æ—Ç–∏—Ç–µ ‚Äú—Ç–æ–ª—å–∫–æ —Ç–∞–π–º–∏–Ω–≥‚Äù –∏–ª–∏ ‚Äú—Å –ø–æ–¥—Å–∫–∞–∑–∫–∞–º–∏‚Äù?', [
            {label:'–¢–æ–ª—å–∫–æ —Ç–∞–π–º–∏–Ω–≥', value:'sleep:timing'},
            {label:'–° –ø–æ–¥—Å–∫–∞–∑–∫–∞–º–∏', value:'sleep:coach'}
          ]);
          return;
        }
      }
      if (value === 'sleep:tips'){
        if (state.activeFlow === 'sleep'){
          aeroSay('–°–æ–≤–µ—Ç—ã –¥–ª—è —Å–Ω–∞:\n‚Ä¢ –ú–∞—Å–∫–∞/–±–µ—Ä—É—à–∏\n‚Ä¢ –ü–ª–µ–¥ –ø–æ–¥ –ø–æ—è—Å–Ω–∏—Ü—É\n‚Ä¢ –°—É–º–∫–∞ –ø–æ–¥ —Å—Ç—É–ø–Ω–∏\n‚Ä¢ –í–æ–¥–∞ –Ω–µ–±–æ–ª—å—à–∏–º–∏ –≥–ª–æ—Ç–∫–∞–º–∏\n\n–ï—Å–ª–∏ –≤—ã —É –æ–∫–Ω–∞/–ø—Ä–æ—Ö–æ–¥–∞ ‚Äî —Å–∫–∞–∂–∏—Ç–µ, –ø–æ–¥—Å–∫–∞–∂—É –ø–æ–∑—É.');
          resetFlow();
          return;
        }
      }
      if (value === 'sleep:more2'){
        if (state.activeFlow === 'sleep'){
          aeroSay('–ï—â—ë 2 –º–∏–Ω—É—Ç—ã:\n–í–¥–æ—Ö 4 ‚Äî –≤—ã–¥–æ—Ö 8.\n–ï—Å–ª–∏ —Å–±–∏–ª–∏—Å—å ‚Äî —Å–ø–æ–∫–æ–π–Ω–æ –Ω–∞—á–Ω–∏—Ç–µ –∑–∞–Ω–æ–≤–æ.\n\n–ì–æ—Ç–æ–≤–æ.');
          resetFlow();
          return;
        }
      }
      if (value === 'sleep:done'){
        if (state.activeFlow === 'sleep'){
          aeroSay('–û–∫–µ–π. –ï—Å–ª–∏ –º—ã—Å–ª–∏ –º–µ—à–∞—é—Ç ‚Äî —Å—á–∏—Ç–∞–π—Ç–µ –≤—ã–¥–æ—Ö–∏ –æ—Ç 1 –¥–æ 20 –∏ —Å–Ω–æ–≤–∞ —Å 1.');
          resetFlow();
          return;
        }
      }
      if (value === 'sleep:timing' || value === 'sleep:coach'){
        if (state.activeFlow === 'sleep'){
          state.step = 'sleep10Start';
          aeroSay('–°–∫–∞–∂–∏—Ç–µ ‚Äú—Å—Ç–∞—Ä—Ç‚Äù. –Ø –ø—Ä–æ–≤–µ–¥—É –ø–æ —ç—Ç–∞–ø–∞–º –∫–æ—Ä–æ—Ç–∫–∏–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏.');
          return;
        }
      }

      // flyover quick chips (we pass as plain text, so it will go to text handler usually)
      // aircraft internals
      if (value === 'air:more' || value === 'air:speed' || value === 'air:turb'){
        if (state.activeFlow === 'aircraft'){
          if (value === 'air:more'){ handleAircraftText('–µ—â—ë'); return; }
          if (value === 'air:speed'){ handleAircraftText('—Å–∫–æ—Ä–æ—Å—Ç—å'); return; }
          if (value === 'air:turb'){ handleAircraftText('—Ç—É—Ä–±—É–ª–µ–Ω—Ç–Ω–æ—Å—Ç—å'); return; }
        }
      }

      // crew internals
      if (value.startsWith('crew:') && state.activeFlow === 'crew'){
        handleCrewInternal(value);
        return;
      }
    }

    function resetFlow(){
      state.activeFlow = null;
      state.step = null;
      state.data = {};
    }

    // ===== WATCH handlers =====
    function handleWatchText(text){
      const t = normalize(text);

      if (state.step === 'askDuration'){
        const d = parseDuration(text);
        if (d === null){
          errorPickFromList(chipsDuration);
          return;
        }
        state.data.duration = d;
        state.data.bucket = durationToBucket(d);

        state.step = 'askGenre';
        if (state.data.genreKey){
          aeroSay('–ñ–∞–Ω—Ä –ø–æ–Ω—è–ª. –§–æ—Ä–º–∞—Ç: —Å–µ—Ä–∏–∞–ª –∏–ª–∏ —Ñ–∏–ª—å–º?', chipsFormat);
          state.step = 'askFormat';
        } else {
          aeroSay('–û–∫–µ–π. –ö–∞–∫–æ–π –∂–∞–Ω—Ä –±–µ—Ä—ë–º?', chipsGenre);
        }
        return;
      }

      if (state.step === 'askGenre'){
        const gk = genreToKey(text);
        if (!gk){
          errorPickFromList(chipsGenre);
          return;
        }
        state.data.genreKey = gk;
        state.step = 'askFormat';
        aeroSay('–§–æ—Ä–º–∞—Ç: —Å–µ—Ä–∏–∞–ª –∏–ª–∏ —Ñ–∏–ª—å–º?', chipsFormat);
        return;
      }

      if (state.step === 'askFormat'){
        const fk = formatToKey(text);
        if (!fk){
          errorPickFromList(chipsFormat);
          return;
        }
        state.data.formatKey = fk;
        showWatchResult();
        return;
      }

      if (state.step === 'refine'){
        if (t.includes('–ø–æ–∂–µ—Å—Ç') || t.includes('–ø–æ–∂—ë—Å—Ç')){
          // –µ—Å–ª–∏ —Ñ–æ—Ä–º–∞—Ç –Ω–µ –≤—ã–±—Ä–∞–Ω ‚Äî –ø–æ–ø—Ä–æ—Å–∏–º
          if (!state.data.formatKey){
            aeroSay('–ß—Ç–æ–±—ã –¥–∞—Ç—å –ø–æ–¥–±–æ—Ä–∫—É, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç: —Å–µ—Ä–∏–∞–ª –∏–ª–∏ —Ñ–∏–ª—å–º?', chipsFormat);
            state.step = 'askFormat';
            state.data.genreKey = 'detective';
            return;
          }
          state.data.genreKey = 'detective';
          const res = buildWatchResult(state.data.bucket || 'mid', 'detective', state.data.formatKey);
          aeroSay('–ü–æ–∂—ë—Å—Ç—á–µ:\n' + res, refineChips());
          return;
        }

        const gk = genreToKey(text);
        if (gk){
          // –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤—ë–ª –∂–∞–Ω—Ä –Ω–∞ —ç—Ç–∞–ø–µ refine
          state.data.genreKey = gk;
          if (!state.data.formatKey){
            aeroSay('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç: —Å–µ—Ä–∏–∞–ª –∏–ª–∏ —Ñ–∏–ª—å–º?', chipsFormat);
            state.step = 'askFormat';
            return;
          }
          aeroSay(buildWatchResult(state.data.bucket || 'mid', state.data.genreKey, state.data.formatKey), refineChips());
          return;
        }

        if (t.includes('–ø–æ–ª–µ–≥—á')){
          state.data.genreKey = 'comedy';
          if (!state.data.formatKey){
            aeroSay('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç: —Å–µ—Ä–∏–∞–ª –∏–ª–∏ —Ñ–∏–ª—å–º?', chipsFormat);
            state.step = 'askFormat';
            return;
          }
          aeroSay('–ü–æ–ª–µ–≥—á–µ:\n' + buildWatchResult(state.data.bucket || 'mid', 'comedy', state.data.formatKey), refineChips());
          return;
        }

        errorPickFromList(refineChips());
        return;
      }

      // fallback
      errorPickFromList([
        {label:'–í—ã–±—Ä–∞—Ç—å –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å', value:'start:watch'}
      ]);
    }

    function refineChips(){
      return [
        {label:'–ü–æ–ª–µ–≥—á–µ', value:'watch:lighter'},
        {label:'–ü–æ–∂—ë—Å—Ç—á–µ', value:'watch:harder'},
        {label:'–°–º–µ–Ω–∏—Ç—å –∂–∞–Ω—Ä', value:'watch:genre'}
      ];
    }

    function showWatchResult(){
      if (!state.data.bucket){
        state.data.bucket = durationToBucket(state.data.duration || 'mid');
      }
      if (!state.data.genreKey || !state.data.formatKey){
        // –µ—Å–ª–∏ —á–µ–≥–æ-—Ç–æ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç ‚Äî –ø—Ä–æ—Å–∏–º –≤—ã–±—Ä–∞—Ç—å
        if (!state.data.genreKey){
          aeroSay('–í—ã–±–µ—Ä–∏—Ç–µ –∂–∞–Ω—Ä:', chipsGenre);
          state.step = 'askGenre';
          return;
        }
        if (!state.data.formatKey){
          aeroSay('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç:', chipsFormat);
          state.step = 'askFormat';
          return;
        }
      }

      const res = buildWatchResult(state.data.bucket, state.data.genreKey, state.data.formatKey);
      aeroSay(res, [
        {label:'–ü–æ–ª–µ–≥—á–µ', value:'watch:lighter'},
        {label:'–ü–æ–∂—ë—Å—Ç—á–µ', value:'watch:harder'},
        {label:'–°–º–µ–Ω–∏—Ç—å –∂–∞–Ω—Ä', value:'watch:genre'}
      ]);
      state.step = 'refine';
    }

    // process refine internal commands
    function handleWatchInternal(value){
      if (value === 'watch:lighter'){
        state.data.genreKey = 'comedy';
        showWatchResult();
        return;
      }
      if (value === 'watch:harder'){
        state.data.genreKey = 'detective';
        showWatchResult();
        return;
      }
      if (value === 'watch:genre'){
        aeroSay('–í—ã–±–µ—Ä–∏—Ç–µ –∂–∞–Ω—Ä:', chipsGenre);
        state.step = 'askGenre';
        return;
      }
    }

    // ===== SLEEP handlers =====
    function handleSleepText(text){
      const t = normalize(text);

      if (state.step === 'sleepIntro'){
        if (t.includes('5')){ processInternal('sleep:5', '5 –º–∏–Ω—É—Ç'); return; }
        if (t.includes('10')){ processInternal('sleep:10', '10 –º–∏–Ω—É—Ç'); return; }
        if (t.includes('—Å–æ–≤–µ—Ç') || t.includes('tips')){ processInternal('sleep:tips', '–ü—Ä–æ—Å—Ç–æ —Å–æ–≤–µ—Ç—ã'); return; }
        errorPickFromList([
          {label:'5 –º–∏–Ω—É—Ç', value:'sleep:5'},
          {label:'10 –º–∏–Ω—É—Ç', value:'sleep:10'},
          {label:'–ü—Ä–æ—Å—Ç–æ —Å–æ–≤–µ—Ç—ã', value:'sleep:tips'}
        ]);
        return;
      }

      if (state.step === 'sleep5'){
        if (t.includes('–µ—â—ë')){ processInternal('sleep:more2', '–î–∞, –µ—â—ë 2'); return; }
        if (t.includes('–¥–æ—Å—Ç–∞—Ç')){ processInternal('sleep:done', '–ù–µ—Ç, –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ'); return; }
        errorPickFromList([
          {label:'–î–∞, –µ—â—ë 2', value:'sleep:more2'},
          {label:'–ù–µ—Ç, –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ', value:'sleep:done'}
        ]);
        return;
      }

      if (state.step === 'sleep10'){
        if (t.includes('—Ç–∞–π–º–∏–Ω–≥')){ processInternal('sleep:timing', '–¢–æ–ª—å–∫–æ —Ç–∞–π–º–∏–Ω–≥'); return; }
        if (t.includes('–ø–æ–¥—Å–∫–∞–∑')){ processInternal('sleep:coach', '–° –ø–æ–¥—Å–∫–∞–∑–∫–∞–º–∏'); return; }
        errorPickFromList([
          {label:'–¢–æ–ª—å–∫–æ —Ç–∞–π–º–∏–Ω–≥', value:'sleep:timing'},
          {label:'–° –ø–æ–¥—Å–∫–∞–∑–∫–∞–º–∏', value:'sleep:coach'}
        ]);
        return;
      }

      if (state.step === 'sleep10Start'){
        if (t.includes('—Å—Ç–∞—Ä—Ç')){
          aeroSay('–°—Ç–∞—Ä—Ç. 2 –º–∏–Ω—É—Ç—ã: –≤–¥–æ—Ö 4 ‚Äî –≤—ã–¥–æ—Ö 6.');
          setTimeout(() => aeroSay('–î–∞–ª—å—à–µ. 3 –º–∏–Ω—É—Ç—ã: —Ä–∞—Å—Å–ª–∞–±—å—Ç–µ –ª–æ–± ‚Üí –≥–ª–∞–∑–∞ ‚Üí —á–µ–ª—é—Å—Ç—å ‚Üí –ø–ª–µ—á–∏ ‚Üí —Ä—É–∫–∏.'), 2200);
          setTimeout(() => aeroSay('–§–∏–Ω–∞–ª. 5 –º–∏–Ω—É—Ç: –ø—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ ‚Äú—Ç–∏—Ö–∏–π –∫–æ—Ä–∏–¥–æ—Ä‚Äù, –∫–∞–∂–¥—ã–π —à–∞–≥ ‚Äî –≤—ã–¥–æ—Ö.'), 4400);
          setTimeout(() => { aeroSay('–ì–æ—Ç–æ–≤–æ. –ï—Å–ª–∏ —Ö–æ—á–µ—Ç—Å—è ‚Äî –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ —Ñ–∏–Ω–∞–ª –µ—â—ë 3‚Äì5 –º–∏–Ω—É—Ç.'); resetFlow(); }, 6600);
          return;
        }
        aeroSay('–ù–∞–ø–∏—à–∏—Ç–µ ‚Äú—Å—Ç–∞—Ä—Ç‚Äù.');
        return;
      }

      errorPickFromList([
        {label:'5 –º–∏–Ω—É—Ç', value:'sleep:5'},
        {label:'10 –º–∏–Ω—É—Ç', value:'sleep:10'}
      ]);
    }

    // ===== FLYOVER handlers =====
    function handleFlyoverText(text){
      if (state.step !== 'flyoverAskTime'){
        state.step = 'flyoverAskTime';
      }
      const mins = parseMinutesLoose(text);
      if (mins == null){
        errorPickFromList([
          {label:'20 –º–∏–Ω—É—Ç', value:'fly:20'},
          {label:'0:45', value:'fly:045'},
          {label:'1:10', value:'fly:110'}
        ]);
        return;
      }
      aeroSay(flyoverAnswer(mins), [
        {label:'20 –º–∏–Ω—É—Ç', value:'fly:20'},
        {label:'0:45', value:'fly:045'},
        {label:'1:10', value:'fly:110'}
      ]);
    }

    // ===== AIRCRAFT handlers =====
    function handleAircraftText(text){
      const t = normalize(text);

      if (t.includes('—Å–∫–æ—Ä–æ—Å—Ç')){
        aeroSay('–ö—Ä–µ–π—Å–µ—Ä—Å–∫–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å —É –ª–∞–π–Ω–µ—Ä–æ–≤ –æ–±—ã—á–Ω–æ –ø–æ—Ä—è–¥–∫–∞ 800‚Äì900 –∫–º/—á. –í–µ—Ç–µ—Ä –º–æ–∂–µ—Ç –∑–∞–º–µ—Ç–Ω–æ –º–µ–Ω—è—Ç—å —Å–∫–æ—Ä–æ—Å—Ç—å ‚Äú–ø–æ –∑–µ–º–ª–µ‚Äù.', [
          {label:'–ï—â—ë —Ñ–∞–∫—Ç', value:'air:more'},
          {label:'–ü—Ä–æ —Ç—É—Ä–±—É–ª–µ–Ω—Ç–Ω–æ—Å—Ç—å', value:'air:turb'}
        ]);
        return;
      }

      if (t.includes('—Ç—É—Ä–±—É–ª')){
        aeroSay('–ï—Å–ª–∏ —Ç—Ä—è—Å—ë—Ç: —Ä–µ–º–µ–Ω—å –ø—Ä–∏—Å—Ç—ë–≥–Ω—É—Ç. –≠–∫–∏–ø–∞–∂ –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å —ç—à–µ–ª–æ–Ω/—Å–∫–æ—Ä–æ—Å—Ç—å –∏ –æ–±—Ö–æ–¥–∏—Ç—å –∑–æ–Ω—ã –ø–æ –ø–æ–≥–æ–¥–µ –∏ –¥–æ–∫–ª–∞–¥–∞–º.', [
          {label:'–ï—â—ë —Ñ–∞–∫—Ç', value:'air:more'},
          {label:'–ü—Ä–æ —Å–∫–æ—Ä–æ—Å—Ç—å', value:'air:speed'}
        ]);
        return;
      }

      if (t.includes('–µ—â—ë')){
        const facts = [
          '–í —Å–∞–ª–æ–Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –¥–∞–≤–ª–µ–Ω–∏–µ, —á—Ç–æ–±—ã –±—ã–ª–æ –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ –¥—ã—à–∞—Ç—å –Ω–∞ –≤—ã—Å–æ—Ç–µ.',
          '–ó–∞–∫—Ä—ã–ª–∫–∏ –∏ –ø—Ä–µ–¥–∫—Ä—ã–ª–∫–∏ –ø–æ–º–æ–≥–∞—é—Ç –ª–µ—Ç–∞—Ç—å –Ω–∞ –º–µ–Ω—å—à–µ–π —Å–∫–æ—Ä–æ—Å—Ç–∏ –ø—Ä–∏ –≤–∑–ª—ë—Ç–µ –∏ –ø–æ—Å–∞–¥–∫–µ.',
          '–ü—Ä–∏ –ø–æ—Å–∞–¥–∫–µ —Å–∞–º–æ–ª—ë—Ç ‚Äú–ø—Ä–∏–±–∏—Ä–∞–µ—Ç‚Äù –ø–æ–¥—ä—ë–º–Ω—É—é —Å–∏–ª—É –∏ –≥–∞—Å–∏—Ç —Å–∫–æ—Ä–æ—Å—Ç—å ‚Äî –ø–æ—ç—Ç–æ–º—É –æ—â—É—â–∞—é—Ç—Å—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —É–≥–ª–∞ –∏ —à—É–º–∞.'
        ];
        aeroSay(facts[Math.floor(Math.random()*facts.length)], [
          {label:'–ï—â—ë —Ñ–∞–∫—Ç', value:'air:more'},
          {label:'–ü—Ä–æ —Å–∫–æ—Ä–æ—Å—Ç—å', value:'air:speed'},
          {label:'–ü—Ä–æ —Ç—É—Ä–±—É–ª–µ–Ω—Ç–Ω–æ—Å—Ç—å', value:'air:turb'}
        ]);
        return;
      }

      errorPickFromList([
        {label:'–ï—â—ë —Ñ–∞–∫—Ç', value:'air:more'},
        {label:'–ü—Ä–æ —Å–∫–æ—Ä–æ—Å—Ç—å', value:'air:speed'},
        {label:'–ü—Ä–æ —Ç—É—Ä–±—É–ª–µ–Ω—Ç–Ω–æ—Å—Ç—å', value:'air:turb'}
      ]);
    }

    // ===== CREW handlers =====
    function handleCrewInternal(value){
      const map = {
        'crew:water': '–ü—Ä–∏–Ω–µ—Å–∏—Ç–µ –≤–æ–¥—É',
        'crew:pillow': '–ù—É–∂–Ω–∞ –ø–æ–¥—É—à–∫–∞',
        'crew:dinner': '–ó–∞–∫–∞–∂–∏—Ç–µ —É–∂–∏–Ω',
        'crew:kids': '–ü—Ä–∏–Ω–µ—Å–∏—Ç–µ –¥–µ—Ç—Å–∫–æ–µ –º–µ–Ω—é'
      };

      const phrase = map[value];
      if (!phrase){
        errorPickFromList(chipsCrew);
        return;
      }

      aeroSay(`–ü—Ä–∏–Ω—è—Ç–æ: ¬´${phrase}¬ª. –•–æ—Ç–∏—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å —á—Ç–æ-—Ç–æ –µ—â—ë?`, [
        {label:'–ï—â—ë –∑–∞–ø—Ä–æ—Å', value:'crew:more'},
        {label:'–ì–æ—Ç–æ–≤–æ', value:'crew:done'}
      ]);
      state.step = 'crewDone';
    }

    function handleCrewText(text){
      const t = normalize(text);

      if (state.step === 'crewPick'){
        if (t.includes('–≤–æ–¥—É')){ handleCrewInternal('crew:water'); return; }
        if (t.includes('–ø–æ–¥—É—à')){ handleCrewInternal('crew:pillow'); return; }
        if (t.includes('—É–∂–∏–Ω')){ handleCrewInternal('crew:dinner'); return; }
        if (t.includes('–¥–µ—Ç—Å–∫') && (t.includes('–º–µ–Ω—é') || t.includes('–¥–µ—Ç—Å–∫–æ–µ'))){ handleCrewInternal('crew:kids'); return; }
        errorPickFromList(chipsCrew);
        return;
      }

      if (state.step === 'crewDone'){
        if (t.includes('–µ—â—ë')){
          state.step = 'crewPick';
          aeroSay('–ß—Ç–æ –ø–µ—Ä–µ–¥–∞—Ç—å –±–æ—Ä—Ç–ø—Ä–æ–≤–æ–¥–Ω–∏–∫—É?', chipsCrew);
          return;
        }
        if (t.includes('–≥–æ—Ç–æ–≤')){
          aeroSay('–•–æ—Ä–æ—à–æ.');
          resetFlow();
          return;
        }
        errorPickFromList([
          {label:'–ï—â—ë –∑–∞–ø—Ä–æ—Å', value:'crew:more'},
          {label:'–ì–æ—Ç–æ–≤–æ', value:'crew:done'}
        ]);
        return;
      }

      // fallback
      state.step = 'crewPick';
      aeroSay('–ß—Ç–æ –ø–µ—Ä–µ–¥–∞—Ç—å –±–æ—Ä—Ç–ø—Ä–æ–≤–æ–¥–Ω–∏–∫—É?', chipsCrew);
    }

    // ===== Main: send =====
    function send(){
      const text = inputEl.value.trim();
      if (!text) return;
      inputEl.value = '';
      handleUserInput(text, false, null);
    }

    // Also handle internal values from chips that are not routed above (watch refine, flyover shortcut, crew done)
    document.addEventListener('click', (e) => {
      // noop - chips already bound per-message
    });

    // Override processInternal for a few extra internal values
    const _processInternal = processInternal;
    processInternal = function(value, displayText){
      // watch refine internals
      if (value === 'watch:lighter' || value === 'watch:harder' || value === 'watch:genre'){
        handleWatchInternal(value);
        return;
      }
      // crew done/more
      if (value === 'crew:more' && state.activeFlow === 'crew'){
        state.step = 'crewPick';
        aeroSay('–ß—Ç–æ –ø–µ—Ä–µ–¥–∞—Ç—å –±–æ—Ä—Ç–ø—Ä–æ–≤–æ–¥–Ω–∏–∫—É?', chipsCrew);
        return;
      }
      if (value === 'crew:done' && state.activeFlow === 'crew'){
        aeroSay('–•–æ—Ä–æ—à–æ.');
        resetFlow();
        return;
      }
      // flyover shortcuts
      if (value === 'fly:20'){ handleFlyoverText('20 –º–∏–Ω—É—Ç'); return; }
      if (value === 'fly:045'){ handleFlyoverText('0:45'); return; }
      if (value === 'fly:110'){ handleFlyoverText('1:10'); return; }

      _processInternal(value, displayText);
    };

    sendEl.addEventListener('click', send);
    inputEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') send();
    });

    window.addEventListener('load', () => {
      inputEl.focus();
      messagesEl.scrollTop = messagesEl.scrollHeight;
    });

    window.addEventListener('resize', () => {
      requestAnimationFrame(() => {
        messagesEl.scrollTop = messagesEl.scrollHeight;
      });
    });
  </script>
</body>
</html>




