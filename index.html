<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>–ê—ç—Ä–æ–¥—Ä—É–≥</title>

  <style>
    :root{
      --bgTop:#0b4f87;
      --bgMid:#083a6d;
      --bgBot:#062a55;

      --text:#fff;
      --muted:rgba(255,255,255,.72);

      --bubble-bot: rgba(255,255,255,.14);
      --bubble-user:#f28a2a;

      --stroke: rgba(255,255,255,.14);

      --input-bg: rgba(255,255,255,.16);
      --input-stroke: rgba(255,255,255,.16);

      --btn-bg: rgba(255,255,255,.10);
      --btn-stroke: rgba(255,255,255,.18);

      --overlay: rgba(0,0,0,.38);
      --panel: rgba(7, 40, 80, .92);
      --panel-stroke: rgba(255,255,255,.14);

      --drawer: rgba(7, 32, 66, .96);

      --radius:18px;

      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);

      --header-h: 88px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      color:var(--text);
      background: radial-gradient(1200px 900px at 35% 25%, var(--bgTop) 0%, var(--bgMid) 45%, var(--bgBot) 100%);
      overflow:hidden;
    }

    .app{ height:100%; display:flex; flex-direction:column; }

    header{
      height: calc(var(--header-h) + var(--safe-top));
      padding: calc(14px + var(--safe-top)) 18px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(0,0,0,.14), rgba(0,0,0,0));
      backdrop-filter: blur(6px);
      position:relative;
      z-index:2;
    }

    .icon-btn{
      width:46px;height:46px;
      border-radius:16px;
      border:1px solid var(--btn-stroke);
      background: var(--btn-bg);
      display:grid;
      place-items:center;
      box-shadow: 0 10px 22px rgba(0,0,0,.18);
      cursor:pointer;
      padding:0;
    }
    .icon-btn img{ width:22px;height:22px; object-fit:contain; display:block; }
    .brand img{ height:22px; width:auto; display:block; }

    .titlebar{ padding: 10px 20px 6px; }
    .titlebar h1{
      margin:0;
      font-size: 40px;
      font-weight: 800;
      letter-spacing:.2px;
      line-height:1.05;
    }

    .chat{
      flex:1;
      display:flex;
      flex-direction:column;
      min-height:0;
      padding: 0 16px;
      position:relative;
    }

    .messages{
      flex:1;
      min-height:0;
      overflow:auto;
      padding: 8px 0 12px;
      -webkit-overflow-scrolling: touch;
      scroll-behavior:smooth;
    }
    .messages::-webkit-scrollbar{ width:8px; }
    .messages::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,.18);
      border-radius: 10px;
    }

    .empty-hint{
      margin: 18px 0 0;
      padding: 14px 14px;
      border: 1px dashed rgba(255,255,255,.18);
      border-radius: 16px;
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.78);
      line-height: 1.35;
    }

    .msg{ margin: 18px 0; display:flex; flex-direction:column; gap:6px; }
    .msg.bot{ align-items:flex-start; }
    .msg.user{ align-items:flex-end; }

    .label{
      font-size: 11px;
      letter-spacing: .6px;
      text-transform: uppercase;
      color: rgba(255,255,255,.55);
      padding: 0 6px;
    }

    .bubble{
      max-width: 78%;
      padding: 14px 16px;
      border-radius: var(--radius);
      border: 1px solid var(--stroke);
      box-shadow: 0 10px 22px rgba(0,0,0,.14);
      backdrop-filter: blur(6px);
      line-height: 1.35;
      font-size: 16px;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .bot .bubble{ background: var(--bubble-bot); border-bottom-left-radius: 10px; }
    .user .bubble{ background: var(--bubble-user); border-color: rgba(255,255,255,.08); border-bottom-right-radius: 10px; }

    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      padding: 0 6px;
      margin-top: 4px;
    }
    .chip{
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.10);
      color: rgba(255,255,255,.92);
      border-radius: 14px;
      padding: 10px 12px;
      font-size: 14px;
      cursor:pointer;
      box-shadow: 0 10px 20px rgba(0,0,0,.12);
      user-select:none;
    }
    .chip:active{ transform: translateY(1px); }

    /* ===== Action buttons row ABOVE input (–∫–∞–∫ –Ω–∞ –ø—Ä–∏–º–µ—Ä–µ) ===== */
    .actionRow{
      display:flex;
      gap:12px;
      padding: 8px 0 10px;
      align-items:stretch;
    }
    .actionBtn{
      flex:1;
      height:44px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.10);
      color: rgba(255,255,255,.92);
      box-shadow: 0 10px 20px rgba(0,0,0,.12);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      font-size: 14px;
      font-weight: 800;
      user-select:none;
      white-space:nowrap;
      padding: 0 14px;
    }
    .actionBtn:active{ transform: translateY(1px); }

    .actionBtn.orange{
      background: var(--bubble-user);
      border-color: rgba(255,255,255,.12);
      color:#fff;
    }
    .actionBtn.voice-on{
      outline: 2px solid rgba(242,138,42,.55);
    }

    /* ===== composer ===== */
    .composer{
      padding: 0 0 calc(12px + var(--safe-bottom));
      position:relative;
      z-index:1;
    }
    .inputRow{
      display:flex;
      align-items:center;
      gap:12px;
      padding: 0 0 0;
    }
    .plus{
      width:54px;height:54px;
      border-radius: 16px;
      border: 1px solid var(--btn-stroke);
      background: rgba(255,255,255,.10);
      display:grid;
      place-items:center;
      box-shadow: 0 10px 22px rgba(0,0,0,.18);
      cursor:pointer;
      padding:0;
    }
    .plus img{ width:22px;height:22px; display:block; }

    .input{
      flex:1;
      height:54px;
      border-radius: 18px;
      border: 1px solid var(--input-stroke);
      background: var(--input-bg);
      color: var(--text);
      outline:none;
      padding: 0 16px;
      font-size: 17px;
      box-shadow: 0 10px 22px rgba(0,0,0,.16);
    }
    .input::placeholder{ color: rgba(255,255,255,.70); }

    .send{
      width:56px;height:54px;
      border-radius: 18px;
      border:none;
      background: var(--bubble-user);
      box-shadow: 0 12px 24px rgba(0,0,0,.22);
      display:grid;
      place-items:center;
      cursor:pointer;
      padding:0;
    }
    .send img{ width:22px;height:22px; display:block; }

    /* ===== popup ===== */
    .overlay{
      position:absolute;
      inset:0;
      background: var(--overlay);
      backdrop-filter: blur(4px);
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease;
      z-index:10;
    }
    .overlay.open{ opacity:1; pointer-events:auto; }

    .sheet{
      position:absolute;
      left: 16px;
      right: 16px;
      bottom: calc(12px + 44px + 10px + 54px + 24px + var(--safe-bottom)); /* –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ –Ω–∞–¥ –±–ª–æ–∫–æ–º */
      border-radius: 22px;
      border: 1px solid var(--panel-stroke);
      background: var(--panel);
      box-shadow: 0 24px 60px rgba(0,0,0,.28);
      padding: 14px;
      transform: translateY(10px);
      opacity:0;
      transition: transform .18s ease, opacity .18s ease;
    }
    .overlay.open .sheet{ transform: translateY(0); opacity:1; }

    .sheet-title{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      padding: 4px 4px 10px;
    }
    .sheet-title h2{
      margin:0;
      font-size: 28px;
      font-weight: 900;
      letter-spacing:.2px;
      color:#fff;
    }
    .sheet-title p{
      margin:6px 0 0;
      color: rgba(255,255,255,.78);
      font-size: 18px;
      line-height: 1.25;
    }
    .sheet-close{
      width:52px;height:52px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.08);
      color: rgba(255,255,255,.92);
      cursor:pointer;
      font-size: 30px;
      line-height: 1;
      display:grid;
      place-items:center;
    }

    .actions{ display:grid; grid-template-columns: 1fr; gap:12px; margin-top: 10px; }
    .action-card{
      width:100%;
      text-align:left;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.10);
      border-radius: 22px;
      padding: 16px 16px;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:12px;
      color:#fff;
    }
    .action-card:active{ transform: translateY(1px); }
    .action-name{ font-weight: 900; font-size: 22px; line-height: 1.1; color:#fff; }
    .action-desc{ font-size: 18px; color: rgba(255,255,255,.78); line-height: 1.2; }

    /* ===== Drawer ===== */
    .drawerOverlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.42);
      backdrop-filter: blur(4px);
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease;
      z-index:30;
    }
    .drawerOverlay.open{ opacity:1; pointer-events:auto; }

    .drawer{
      position:absolute;
      top:0; left:0;
      height:100%;
      width:min(360px, 86vw);
      padding: calc(18px + var(--safe-top)) 16px calc(16px + var(--safe-bottom));
      background: var(--drawer);
      border-right: 1px solid rgba(255,255,255,.12);
      box-shadow: 18px 0 40px rgba(0,0,0,.30);
      transform: translateX(-10px);
      opacity:0;
      transition: transform .18s ease, opacity .18s ease;
      display:flex;
      flex-direction:column;
      gap:14px;
    }
    .drawerOverlay.open .drawer{ transform: translateX(0); opacity:1; }

    .drawerTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding-bottom: 6px;
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .drawerTitle{ font-size: 20px; font-weight: 900; letter-spacing:.2px; }
    .drawerClose{
      width:44px;height:44px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.08);
      color:#fff;
      font-size: 28px;
      line-height: 1;
      cursor:pointer;
      display:grid;
      place-items:center;
    }

    .nav{ display:flex; flex-direction:column; gap:10px; padding-top: 6px; }
    .navItem{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);
      border-radius: 18px;
      padding: 14px 14px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      color:#fff;
      user-select:none;
    }
    .navItem.active{
      background: rgba(242,138,42,.20);
      border-color: rgba(242,138,42,.40);
    }
    .navItem .name{ font-size: 16px; font-weight: 900; }
    .navItem .sub{ font-size: 13px; color: rgba(255,255,255,.70); margin-top: 3px; }

    .drawerFooter{
      margin-top:auto;
      border-top: 1px solid rgba(255,255,255,.10);
      padding-top: 14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .langRow{ display:flex; gap:10px; flex-wrap:wrap; }
    .langBtn{
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.08);
      color:#fff;
      border-radius: 999px;
      padding: 10px 12px;
      cursor:pointer;
      font-weight: 800;
      font-size: 13px;
    }
    .langBtn.active{
      background: rgba(242,138,42,.22);
      border-color: rgba(242,138,42,.42);
    }

    @media (min-width: 820px) and (orientation: landscape){
      .app{ align-items:center; }
      header,.titlebar,.chat{ width: min(920px, 92vw); }
      .bubble{ max-width: 62%; }
      .titlebar h1{ font-size: 44px; }
      .sheet{ left: 0; right: 0; }
    }
  </style>
</head>

<body>
  <div class="app">
    <header>
      <button id="burger" class="icon-btn" type="button" aria-label="–ú–µ–Ω—é">
        <img src="Icon/Burger-menu.svg" alt="" />
      </button>

      <div class="brand" aria-label="Aeroflot">
        <img src="Logo/CMYK.svg" alt="AEROFLOT" />
      </div>
    </header>

    <div class="titlebar">
      <h1 id="titleH1">–ê—ç—Ä–æ–¥—Ä—É–≥</h1>
    </div>

    <main class="chat">
      <div id="messages" class="messages" role="log" aria-live="polite" aria-relevant="additions">
        <div id="emptyHint" class="empty-hint">–ù–∞–∂–º–∏—Ç–µ ¬´+¬ª –¥–ª—è —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –∏–ª–∏ –∑–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å ‚Äî —è –ø–æ–º–æ–≥—É –ø–æ —Ö–æ–¥—É –ø–æ–ª—ë—Ç–∞.</div>
      </div>

      <!-- Action buttons like in your example -->
      <div class="actionRow" aria-label="–ë—ã—Å—Ç—Ä—ã–µ –∫–Ω–æ–ø–∫–∏">
        <button id="crewBtnFixed" class="actionBtn orange" type="button">–°–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ä—Ç–ø—Ä–æ–≤–æ–¥–Ω–∏–∫—É</button>
        <button id="voiceBtn" class="actionBtn" type="button">–ü–æ–≥–æ–≤–æ—Ä–∏—Ç—å</button>
      </div>

      <div class="composer">
        <div class="inputRow">
          <button id="plus" class="plus" type="button" aria-label="–°—Ü–µ–Ω–∞—Ä–∏–∏">
            <img src="Icon/Plus.svg" alt="" />
          </button>

          <input id="input" class="input" type="text" placeholder="–°–ø—Ä–æ—Å–∏ –º–µ–Ω—è" autocomplete="off" />

          <button id="send" class="send" type="button" aria-label="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">
            <img src="Icon/TextButton/arrow-up_20x20.svg" alt="" />
          </button>
        </div>
      </div>

      <!-- Scenarios sheet -->
      <div id="overlay" class="overlay" aria-hidden="true">
        <div class="sheet" role="dialog" aria-label="–ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å –≤ –ø–æ–ª—ë—Ç–µ">
          <div class="sheet-title">
            <div>
              <h2 id="sheetTitle">–ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å –≤ –ø–æ–ª—ë—Ç–µ</h2>
              <p id="sheetSubtitle">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ü–µ–Ω–∞—Ä–∏–π ‚Äî —è –∑–∞–¥–∞–º –ø–∞—Ä—É –≤–æ–ø—Ä–æ—Å–æ–≤ –∏ –ø—Ä–µ–¥–ª–æ–∂—É –≤–∞—Ä–∏–∞–Ω—Ç.</p>
            </div>
            <button id="closeSheet" class="sheet-close" type="button" aria-label="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
          </div>

          <div class="actions">
            <button class="action-card" type="button" data-action="watch">
              <div style="display:flex; flex-direction:column; gap:6px;">
                <div class="action-name">üé¨ –ü–æ–¥–±–æ—Ä–∫–∞ –Ω–∞ —ç—Ç–æ—Ç —Ä–µ–π—Å</div>
                <div class="action-desc">–§–∏–ª—å–º –∏–ª–∏ —Å–µ—Ä–∏–∞–ª –ø–æ–¥ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ–ª—ë—Ç–∞ –∏ –≤–∫—É—Å.</div>
              </div>
            </button>

            <button class="action-card" type="button" data-action="sleep">
              <div style="display:flex; flex-direction:column; gap:6px;">
                <div class="action-name">üåô –ú—è–≥–∫–æ —É—Å–Ω—É—Ç—å</div>
                <div class="action-desc">–î—ã—Ö–∞–Ω–∏–µ, —Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–∏–µ –∏ ‚Äú–≤—ã–∫–ª—é—á–µ–Ω–∏–µ –≥–æ–ª–æ–≤—ã‚Äù.</div>
              </div>
            </button>

            <button class="action-card" type="button" data-action="flyover">
              <div style="display:flex; flex-direction:column; gap:6px;">
                <div class="action-name">üó∫Ô∏è –ú–∞—Ä—à—Ä—É—Ç –∏ –≥–¥–µ –º—ã</div>
                <div class="action-desc">–ì–æ—Ä–æ–¥–∞ –ø–æ –º–∞—Ä—à—Ä—É—Ç—É –∏ —á—Ç–æ –ø–æ–¥ –Ω–∞–º–∏ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å.</div>
              </div>
            </button>

            <button class="action-card" type="button" data-action="aircraft">
              <div style="display:flex; flex-direction:column; gap:6px;">
                <div class="action-name">‚úàÔ∏è –ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ–µ –æ —Å–∞–º–æ–ª—ë—Ç–µ</div>
                <div class="action-desc">–§–∞–∫—Ç—ã –ø—Ä–æ –ø–æ–ª—ë—Ç, –≤—ã—Å–æ—Ç—É, —Å–∫–æ—Ä–æ—Å—Ç—å –∏ —Ç—É—Ä–±—É–ª–µ–Ω—Ç–Ω–æ—Å—Ç—å.</div>
              </div>
            </button>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Drawer -->
  <div id="drawerOverlay" class="drawerOverlay" aria-hidden="true">
    <aside class="drawer" role="dialog" aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è">
      <div class="drawerTop">
        <div class="drawerTitle">–ù–∞–≤–∏–≥–∞—Ü–∏—è</div>
        <button id="drawerClose" class="drawerClose" type="button" aria-label="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
      </div>

      <nav class="nav">
        <div class="navItem active" data-page="aerofriend">
          <div>
            <div class="name">–ê—ç—Ä–æ–¥—Ä—É–≥</div>
            <div class="sub">–ß–∞—Ç-–ø–æ–º–æ—â–Ω–∏–∫ –≤ –ø–æ–ª—ë—Ç–µ</div>
          </div>
        </div>

        <div class="navItem" data-page="entertainment">
          <div>
            <div class="name">–¶–µ–Ω—Ç—Ä —Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏–π</div>
            <div class="sub">–§–∏–ª—å–º—ã, –º—É–∑—ã–∫–∞, –∏–≥—Ä—ã</div>
          </div>
        </div>

        <div class="navItem" data-page="map3d">
          <div>
            <div class="name">3D-–∫–∞—Ä—Ç–∞</div>
            <div class="sub">–ú–∞—Ä—à—Ä—É—Ç –≤ –æ–±—ä—ë–º–µ</div>
          </div>
        </div>
      </nav>

      <div class="drawerFooter">
        <div style="font-weight:900; letter-spacing:.2px;">–Ø–∑—ã–∫</div>
        <div class="langRow">
          <button class="langBtn active" data-lang="ru">–†—É—Å—Å–∫–∏–π</button>
          <button class="langBtn" data-lang="en">English</button>
          <button class="langBtn" data-lang="tr">T√ºrk√ße</button>
        </div>
      </div>
    </aside>
  </div>

  <script>
    // =========================
    // Helpers
    // =========================
    function normalize(s){ return (s||'').toLowerCase().replace(/—ë/g,'–µ').trim(); }

    const messagesEl = document.getElementById('messages');
    const emptyHintEl = document.getElementById('emptyHint');
    const inputEl = document.getElementById('input');
    const sendEl = document.getElementById('send');

    const burgerEl = document.getElementById('burger');
    const drawerOverlayEl = document.getElementById('drawerOverlay');
    const drawerCloseEl = document.getElementById('drawerClose');

    const plusEl = document.getElementById('plus');
    const overlayEl = document.getElementById('overlay');
    const closeSheetEl = document.getElementById('closeSheet');

    const crewBtnFixedEl = document.getElementById('crewBtnFixed');
    const voiceBtnEl = document.getElementById('voiceBtn');

    function hideEmptyHint(){ if (emptyHintEl) emptyHintEl.style.display = 'none'; }

    function addMessage({from, text, chips}){
      hideEmptyHint();

      const msg = document.createElement('div');
      msg.className = `msg ${from}`;

      const label = document.createElement('div');
      label.className = 'label';
      label.textContent = (from === 'bot') ? '–ê–≠–†–û–î–†–£–ì' : '–í—ã';

      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.textContent = text;

      msg.appendChild(label);
      msg.appendChild(bubble);

      if (Array.isArray(chips) && chips.length){
        const chipsWrap = document.createElement('div');
        chipsWrap.className = 'chips';

        for (const c of chips){
          const b = document.createElement('button');
          b.className = 'chip';
          b.type = 'button';
          b.textContent = c.label;
          b.addEventListener('click', () => handleUserInput(c.label, c.value));
          chipsWrap.appendChild(b);
        }
        msg.appendChild(chipsWrap);
      }

      messagesEl.appendChild(msg);
      requestAnimationFrame(() => { messagesEl.scrollTop = messagesEl.scrollHeight; });
    }

    function aeroSay(text, chips){ addMessage({from:'bot', text, chips}); }
    function userSay(text){ addMessage({from:'user', text}); }

    function errorPickFromList(chips){
      aeroSay('–ü—Ä–æ—Å—Ç–∏—Ç–µ, –Ω–µ –ø–æ–Ω—è–ª, —á—Ç–æ –≤—ã –∏–º–µ–ª–∏ –≤–≤–∏–¥—É. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑ —Å–ø–∏—Å–∫–∞', chips || chipsMainMenu);
    }

    // =========================
    // Scenario / minimal chips
    // =========================
    const chipsMainMenu = [
      {label:'üé¨ –ü–æ–¥–±–æ—Ä–∫–∞ –Ω–∞ —Ä–µ–π—Å', value:'start:watch'},
      {label:'üåô –ú—è–≥–∫–æ —É—Å–Ω—É—Ç—å', value:'start:sleep'},
      {label:'üó∫Ô∏è –ú–∞—Ä—à—Ä—É—Ç –∏ –≥–¥–µ –º—ã', value:'start:flyover'},
      {label:'‚úàÔ∏è –ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ–µ –æ —Å–∞–º–æ–ª—ë—Ç–µ', value:'start:aircraft'},
      {label:'–°–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ä—Ç–ø—Ä–æ–≤–æ–¥–Ω–∏–∫—É', value:'start:crew'}
    ];

    const chipsGenre = [
      {label:'–ö–æ–º–µ–¥–∏—è', value:'genre:comedy'},
      {label:'–î–µ—Ç–µ–∫—Ç–∏–≤/—Ç—Ä–∏–ª–ª–µ—Ä', value:'genre:detective'},
      {label:'–î—Ä–∞–º–∞', value:'genre:drama'},
      {label:'–§–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞', value:'genre:scifi'}
    ];

    const chipsCrew = [
      {label:'–ü—Ä–∏–Ω–µ—Å–∏—Ç–µ –≤–æ–¥—É', value:'crew:water'},
      {label:'–ù—É–∂–Ω–∞ –ø–æ–¥—É—à–∫–∞', value:'crew:pillow'},
      {label:'–ó–∞–∫–∞–∂–∏—Ç–µ —É–∂–∏–Ω', value:'crew:dinner'},
      {label:'–ü—Ä–∏–Ω–µ—Å–∏—Ç–µ –¥–µ—Ç—Å–∫–æ–µ –º–µ–Ω—é', value:'crew:kids'}
    ];
    const chipsCrewAfter = [
      {label:'–ï—â—ë –∑–∞–ø—Ä–æ—Å', value:'crew:more'},
      {label:'–ì–æ—Ç–æ–≤–æ', value:'crew:done'}
    ];

    // =========================
    // State machine (kept minimal; main ask: voice demo + UI)
    // =========================
    const state = {
      flow: null,   // null | watch | crew
      step: null
    };

    function resetFlow(){
      state.flow = null;
      state.step = null;
    }

    function startFlow(flow){
      state.flow = flow;
      state.step = null;

      if (flow === 'crew'){
        state.step = 'crewPick';
        aeroSay('–ß—Ç–æ –ø–µ—Ä–µ–¥–∞—Ç—å –±–æ—Ä—Ç–ø—Ä–æ–≤–æ–¥–Ω–∏–∫—É?', chipsCrew);
        return;
      }

      if (flow === 'watch'){
        state.step = 'askGenre';
        aeroSay('–ö–∞–∫–æ–π –∂–∞–Ω—Ä —Ö–æ—á–µ—Ç—Å—è –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å?', chipsGenre);
        return;
      }

      resetFlow();
      errorPickFromList(chipsMainMenu);
    }

    function crewPhraseByValue(v){
      const map = {
        'crew:water': '–ü—Ä–∏–Ω–µ—Å–∏—Ç–µ –≤–æ–¥—É',
        'crew:pillow': '–ù—É–∂–Ω–∞ –ø–æ–¥—É—à–∫–∞',
        'crew:dinner': '–ó–∞–∫–∞–∂–∏—Ç–µ —É–∂–∏–Ω',
        'crew:kids': '–ü—Ä–∏–Ω–µ—Å–∏—Ç–µ –¥–µ—Ç—Å–∫–æ–µ –º–µ–Ω—é'
      };
      return map[v] || null;
    }

    function handleInternal(value){
      if (!value) return false;

      if (value.startsWith('start:')){
        startFlow(value.split(':')[1]);
        return true;
      }

      // crew (–∂–µ–ª–µ–∑–Ω–æ)
      if (value === 'crew:done'){
        aeroSay('–•–æ—Ä–æ—à–æ.');
        resetFlow();
        return true;
      }
      if (value === 'crew:more'){
        state.flow = 'crew';
        state.step = 'crewPick';
        aeroSay('–ß—Ç–æ –ø–µ—Ä–µ–¥–∞—Ç—å –±–æ—Ä—Ç–ø—Ä–æ–≤–æ–¥–Ω–∏–∫—É?', chipsCrew);
        return true;
      }
      if (value.startsWith('crew:')){
        state.flow = 'crew';
        state.step = 'crewDone';
        const phrase = crewPhraseByValue(value);
        if (!phrase){
          errorPickFromList(chipsCrew);
          return true;
        }
        aeroSay(`–ü—Ä–∏–Ω—è—Ç–æ: ¬´${phrase}¬ª. –•–æ—Ç–∏—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å —á—Ç–æ-—Ç–æ –µ—â—ë?`, chipsCrewAfter);
        return true;
      }

      // watch genre (demo)
      if (value.startsWith('genre:')){
        state.flow = 'watch';
        state.step = 'done';
        aeroSay('–ü–æ–Ω—è–ª. –°–µ—Ä–∏–∞–ª –∏–ª–∏ —Ñ–∏–ª—å–º?', [
          {label:'–°–µ—Ä–∏–∞–ª', value:'format:series'},
          {label:'–§–∏–ª—å–º', value:'format:film'}
        ]);
        return true;
      }

      if (value.startsWith('format:')){
        state.flow = 'watch';
        state.step = 'done';
        aeroSay('–û–∫–µ–π. –ï—Å–ª–∏ —Å–∫–∞–∂–µ—Ç–µ ‚Äú–ø–æ–∂—ë—Å—Ç—á–µ‚Äù –∏–ª–∏ ‚Äú–ø–æ–ª–µ–≥—á–µ‚Äù ‚Äî –ø–æ–¥—Å—Ç—Ä–æ—é —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.');
        resetFlow();
        return true;
      }

      return false;
    }

    function detectIntent(text){
      const n = normalize(text);

      if (n.includes('–ø—Ä–∏–≤–µ—Ç') || n.includes('–∑–¥—Ä–∞–≤')) return {type:'hello'};
      if (n.includes('—Ö–æ—á—É –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ñ–∏–ª—å–º') || n.includes('—Ö–æ—á—É –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å') || (n.includes('–ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å') && n.includes('—Ñ–∏–ª—å–º'))){
        return {type:'voiceWatchDemo'};
      }

      if (n.includes('–±–æ—Ä—Ç–ø—Ä–æ–≤–æ–¥') || n.includes('–ø—Ä–æ–≤–æ–¥–Ω–∏–∫')) return {type:'start', flow:'crew'};
      if (n.includes('–≤–æ–¥—É')) return {type:'internal', value:'crew:water'};
      if (n.includes('–ø–æ–¥—É—à')) return {type:'internal', value:'crew:pillow'};
      if (n.includes('—É–∂–∏–Ω')) return {type:'internal', value:'crew:dinner'};
      if (n.includes('–¥–µ—Ç—Å–∫') && n.includes('–º–µ–Ω—é')) return {type:'internal', value:'crew:kids'};
      if (n === '–≥–æ—Ç–æ–≤–æ' || n.includes('–≥–æ—Ç–æ–≤')) return {type:'internal', value:'crew:done'};

      return null;
    }

    function handleUserInput(displayText, internalValue=null){
      const text = (displayText || '').trim();
      if (!text) return;

      userSay(text);

      if (internalValue){
        if (!handleInternal(internalValue)) errorPickFromList();
        return;
      }

      const intent = detectIntent(text);

      // voice-demo intents (works for typed too)
      if (intent?.type === 'hello'){
        aeroSay('–ü—Ä–∏–≤–µ—Ç, —á–µ–º —Ç–µ–±–µ –ø–æ–º–æ—á—å?', chipsMainMenu);
        return;
      }
      if (intent?.type === 'voiceWatchDemo'){
        // –∏–º–µ–Ω–Ω–æ —Ç–æ—Ç –æ—Ç–≤–µ—Ç, –∫–æ—Ç–æ—Ä—ã–π –≤—ã –ø—Ä–æ—Å–∏–ª–∏
        state.flow = 'watch';
        state.step = 'askGenre';
        aeroSay('–ö–∞–∫–æ–π –∂–∞–Ω—Ä —Ö–æ—á–µ—Ç—Å—è –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å?', chipsGenre);
        return;
      }

      if (!state.flow){
        if (intent?.type === 'start'){
          startFlow(intent.flow);
          return;
        }
        if (intent?.type === 'internal'){
          handleInternal(intent.value);
          return;
        }
        errorPickFromList(chipsMainMenu);
        return;
      }

      // flow-specific
      if (state.flow === 'crew'){
        // allow typed done always
        if (intent?.type === 'internal'){
          handleInternal(intent.value);
          return;
        }
        errorPickFromList(state.step === 'crewDone' ? chipsCrewAfter : chipsCrew);
        return;
      }

      if (state.flow === 'watch'){
        // accept quick genre triggers by text
        const n = normalize(text);
        if (n.includes('–∫–æ–º–µ–¥')) return handleInternal('genre:comedy');
        if (n.includes('–¥–µ—Ç–µ–∫—Ç') || n.includes('—Ç—Ä–∏–ª')) return handleInternal('genre:detective');
        if (n.includes('–¥—Ä–∞–º')) return handleInternal('genre:drama');
        if (n.includes('—Ñ–∞–Ω—Ç–∞—Å—Ç') || n.includes('—Ñ—ç–Ω—Ç')) return handleInternal('genre:scifi');
        errorPickFromList(chipsGenre);
        return;
      }

      errorPickFromList(chipsMainMenu);
    }

    // =========================
    // UI: send
    // =========================
    function send(){
      const text = inputEl.value.trim();
      if (!text) return;
      inputEl.value = '';
      handleUserInput(text, null);
    }
    sendEl.addEventListener('click', send);
    inputEl.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') send(); });

    // =========================
    // UI: plus sheet
    // =========================
    function openSheet(){ overlayEl.classList.add('open'); overlayEl.setAttribute('aria-hidden','false'); }
    function closeSheet(){ overlayEl.classList.remove('open'); overlayEl.setAttribute('aria-hidden','true'); }
    plusEl.addEventListener('click', ()=> overlayEl.classList.contains('open') ? closeSheet() : openSheet());
    closeSheetEl.addEventListener('click', closeSheet);
    overlayEl.addEventListener('click', (e)=>{ if (e.target === overlayEl) closeSheet(); });
    overlayEl.querySelectorAll('[data-action]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        closeSheet();
        startFlow(btn.getAttribute('data-action'));
      });
    });

    // =========================
    // UI: drawer
    // =========================
    function openDrawer(){ drawerOverlayEl.classList.add('open'); drawerOverlayEl.setAttribute('aria-hidden','false'); }
    function closeDrawer(){ drawerOverlayEl.classList.remove('open'); drawerOverlayEl.setAttribute('aria-hidden','true'); }
    burgerEl.addEventListener('click', openDrawer);
    drawerCloseEl.addEventListener('click', closeDrawer);
    drawerOverlayEl.addEventListener('click', (e)=>{ if (e.target === drawerOverlayEl) closeDrawer(); });

    // Buttons
    crewBtnFixedEl.addEventListener('click', ()=> startFlow('crew'));

    // =========================
    // VOICE: continuous SpeechRecognition session (start once, keep listening until stop)
    // Demo rules:
    //  - Say ‚Äú–ü—Ä–∏–≤–µ—Ç‚Äù -> bot: ‚Äú–ü—Ä–∏–≤–µ—Ç, —á–µ–º —Ç–µ–±–µ –ø–æ–º–æ—á—å?‚Äù
    //  - Say ‚Äú–•–æ—á—É –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ñ–∏–ª—å–º‚Äù -> bot: ‚Äú–ö–∞–∫–æ–π –∂–∞–Ω—Ä —Ö–æ—á–µ—Ç—Å—è –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å?‚Äù
    // =========================
    const Voice = {
      supported: false,
      active: false,
      rec: null
    };

    function setupVoice(){
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) return;

      Voice.supported = true;
      const rec = new SR();
      rec.lang = 'ru-RU';
      rec.continuous = true;
      rec.interimResults = false; // —Ç–æ–ª—å–∫–æ —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ —Ñ—Ä–∞–∑—ã
      rec.maxAlternatives = 1;
      Voice.rec = rec;

      rec.onresult = (event) => {
        // –±–µ—Ä—ë–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        const last = event.results[event.results.length - 1];
        if (!last || !last[0]) return;
        const transcript = (last[0].transcript || '').trim();
        if (!transcript) return;

        // –ü–∏—à–µ–º –∫–∞–∫ –±—É–¥—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–∏–ª —Å–æ–æ–±—â–µ–Ω–∏–µ –≥–æ–ª–æ—Å–æ–º
        userSay(transcript);

        // –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ (–Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–∞—è —Å–µ—Å—Å–∏—è)
        const n = normalize(transcript);

        if (n.includes('–ø—Ä–∏–≤–µ—Ç') || n.includes('–∑–¥—Ä–∞–≤')){
          aeroSay('–ü—Ä–∏–≤–µ—Ç, —á–µ–º —Ç–µ–±–µ –ø–æ–º–æ—á—å?', chipsMainMenu);
          return;
        }

        if (n.includes('—Ö–æ—á—É –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ñ–∏–ª—å–º') || n.includes('—Ö–æ—á—É –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å') || (n.includes('–ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å') && n.includes('—Ñ–∏–ª—å–º'))){
          state.flow = 'watch';
          state.step = 'askGenre';
          aeroSay('–ö–∞–∫–æ–π –∂–∞–Ω—Ä —Ö–æ—á–µ—Ç—Å—è –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å?', chipsGenre);
          return;
        }

        // –∏–Ω–∞—á–µ ‚Äî –æ—Ç–¥–∞—ë–º –≤ –æ–±—â–∏–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ (–±–µ–∑ –¥—É–±–ª—è userSay!)
        // –ó–¥–µ—Å—å –≤–∞–∂–Ω–æ –ù–ï –≤—ã–∑—ã–≤–∞—Ç—å handleUserInput(), –∏–Ω–∞—á–µ –±—É–¥–µ—Ç –¥–≤–æ–π–Ω–æ–µ userSay.
        // –ü–æ—ç—Ç–æ–º—É: –ø—Ä–æ–±—É–µ–º intent –∏ –æ—Ç–≤–µ—á–∞–µ–º –º—è–≥–∫–æ.
        const intent = detectIntent(transcript);
        if (intent?.type === 'internal') { handleInternal(intent.value); return; }
        if (intent?.type === 'start') { startFlow(intent.flow); return; }

        errorPickFromList(chipsMainMenu);
      };

      rec.onerror = () => {
        // –ù–µ —Å–ø–∞–º–∏–º —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏; –ø—Ä–æ—Å—Ç–æ –≤—ã–∫–ª—é—á–∞–µ–º UI
        stopVoice();
      };

      rec.onend = () => {
        // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–∂–∏–º–∞–ª "–ü—Ä–µ–∫—Ä–∞—Ç–∏—Ç—å", –ø—ã—Ç–∞–µ–º—Å—è –¥–µ—Ä–∂–∞—Ç—å —Å–µ—Å—Å–∏—é –∂–∏–≤–æ–π
        if (Voice.active){
          try { rec.start(); } catch(e) {}
        }
      };
    }

    function startVoice(){
      if (!Voice.supported){
        aeroSay('–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –≥–æ–ª–æ—Å–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ–∫—Å—Ç.');
        return;
      }
      Voice.active = true;
      voiceBtnEl.classList.add('voice-on');
      voiceBtnEl.textContent = '–ü—Ä–µ–∫—Ä–∞—Ç–∏—Ç—å';
      try { Voice.rec.start(); } catch(e) {}
      aeroSay('–ì–æ–ª–æ—Å–æ–≤–æ–π —Ä–µ–∂–∏–º –≤–∫–ª—é—á—ë–Ω. –ì–æ–≤–æ—Ä–∏—Ç–µ —Ñ—Ä–∞–∑—ã ‚Äî —è –±—É–¥—É –æ—Ç–≤–µ—á–∞—Ç—å.', [
        {label:'–ß—Ç–æ —è —É–º–µ—é', value:'start:watch'},
        {label:'–°–≤—è–∑—å —Å –±–æ—Ä—Ç–ø—Ä–æ–≤–æ–¥–Ω–∏–∫–æ–º', value:'start:crew'}
      ]);
    }

    function stopVoice(){
      Voice.active = false;
      voiceBtnEl.classList.remove('voice-on');
      voiceBtnEl.textContent = '–ü–æ–≥–æ–≤–æ—Ä–∏—Ç—å';
      if (Voice.rec){
        try { Voice.rec.stop(); } catch(e) {}
      }
    }

    voiceBtnEl.addEventListener('click', () => {
      if (!Voice.active) startVoice();
      else stopVoice();
    });

    // init
    window.addEventListener('load', ()=>{
      inputEl.focus();
      messagesEl.scrollTop = messagesEl.scrollHeight;
      setupVoice();
    });
  </script>
</body>
</html>








